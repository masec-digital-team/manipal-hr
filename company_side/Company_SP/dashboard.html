  <!DOCTYPE html>
  <html lang="en">
  <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HR Dashboard â€” NEO TECH Solutions</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* ===== Root Variables ===== */
    :root {
      --bg:#f6f7f8;
      --card:#ffffff;
      --text:#22303b;
      --muted:#6f7b83;
      --darkgreen:#00533f;
      --lightgreen:#8fd694;
      --yellow:#ffcc00;
      --red:#ff6347;
      --radius:12px;
      --shadow:0 6px 20px rgba(0,0,0,0.06);
      --transition: all 0.3s ease;
    }

    *{box-sizing:border-box;}
    body{margin:0;font-family:"Inter",sans-serif;background:var(--bg);color:var(--text);}
    
    /* Prevent body scroll when modal is open */
    body.modal-open {
      overflow: hidden;
      position: fixed;
      width: 100%;
    }

    /* ===== Top Navigation ===== */
    .topbar{
      background: var(--darkgreen);
      color:#fff;
      position:sticky; top:0; z-index:10;
      box-shadow:0 4px 14px rgba(0,0,0,0.1);
    }
    .topbar-inner{
      max-width:1400px;
      margin:auto;
      padding:14px 20px;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .brand{display:flex;align-items:center;gap:10px;}
    .brand img{width:40px;border-radius:6px;}
    .brand span{font-size:1.2rem;font-weight:700;}
    .main-nav{display:flex;gap:20px;}
    .nav-link{
      color:#fff;text-decoration:none;font-weight:500;position:relative;
      transition:var(--transition);padding:6px 0;
    }
    .nav-link::after{
      content:"";position:absolute;left:0;bottom:-3px;width:0;height:2px;
      background:var(--yellow);border-radius:2px;transition:var(--transition);
    }
    .nav-link:hover::after, .nav-link.active::after{width:100%;}
    .nav-link:hover{opacity:0.9;}
    .avatar{
      width:38px;height:38px;background:rgba(255,255,255,0.15);
      display:flex; align-items:center; justify-content:center;
      border-radius:8px;font-weight:700;cursor:pointer;
      transition:var(--transition);
    }
    .avatar:hover{background:rgba(255,255,255,0.25);}

    /* ===== Container ===== */
    .container{max-width:1400px;margin:28px auto;padding:0 20px}

    /* ===== Quick Actions ===== */
    .quick-actions{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:24px}
    .btn{
      background:#fff;border:1px solid var(--darkgreen);
      color:var(--darkgreen);padding:10px 16px;border-radius:8px;font-weight:600;
      cursor:pointer; transition:var(--transition);
      display:inline-flex;align-items:center;gap:8px;
    }
    .btn:hover{background:var(--darkgreen); color:#fff;transform: translateY(-2px);}
    .btn.primary{background:var(--darkgreen);color:#fff;border:none;}
    .btn.small{padding:6px 10px;font-size:13px;}
    .btn.tiny{padding:5px 8px;font-size:12px;}
    .btn.ghost{background:transparent;border:1px solid #ccc;color:var(--text);}
    .btn.danger{background:var(--red);color:#fff;border:none;}
    .btn.warning{background:var(--yellow);color:var(--text);border:none;}
    .btn.success{background:#28a745;color:#fff;border:none;}

    /* ===== Cards ===== */
    .cards-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      gap:16px; margin-bottom:30px;
    }
    .card{
      background:var(--card);
      border-radius:var(--radius);
      padding:20px;
      box-shadow:var(--shadow);
      text-align:center;
      transition: var(--transition);
      border-top: 4px solid var(--darkgreen);
    }
    .card:hover{
      transform: translateY(-4px);
      box-shadow:0 10px 25px rgba(0,0,0,0.12);
    }
    .card h4{margin:0;font-size:14px;color:var(--muted);text-transform:uppercase;}
    .big-number{font-size:32px;font-weight:700;color:var(--darkgreen);margin:8px 0;}
    .meta{font-size:13px;color:var(--muted);}

    /* ===== Panel Tables ===== */
    .panel{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:20px;
      margin-bottom:26px;
    }
    .panel-head{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:16px;
    }
    .panel-head h3{
      margin:0;
      font-size:18px;
      font-weight:700;
      color:var(--darkgreen);
    }
    .table{
      width:100%;
      border-collapse:collapse;
      font-size:14px;
      border-radius: var(--radius);
      overflow: hidden;
    }
    .table th, .table td{
      padding:12px;
      text-align:left;
    }
    .table th{
      background: var(--darkgreen);
      color: #fff;
      font-weight:600;
      text-transform: uppercase;
    }
    .table tbody tr:nth-child(even){
      background: #f0fdf7;
    }
    .table tbody tr:hover{
      background: var(--lightgreen);
      transition: var(--transition);
    }
    .text-right{text-align:right}
    .search-box{
      padding:8px 12px;
      border-radius:8px;
      border:1px solid #ccc;
      width:250px;
    }

    /* ===== Status Pills ===== */
    .pill{
      display:inline-block;
      padding:5px 10px;
      border-radius:999px;
      font-size:13px;
      font-weight:600;
    }
    .pill.received{background:#e2f7f0;color:var(--darkgreen);}
    .pill.in-process{background:var(--yellow); color:#22303b;}
    .pill.fulfilled{background:var(--lightgreen); color:#22303b;}
    .pill.cancelled{background:var(--red);color:#fff;}

    /* ===== Overlay/Modal ===== */
    .overlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      backdrop-filter: blur(2px);
      justify-content: center;
      align-items: center;
      z-index: 1000;
      overflow-y: auto;
      padding: 20px 0;
    }
    .overlay.active {
      display: flex;
    }
    /* .overlay-content {
      background: #fff;
      border-radius: var(--radius);
      padding: 30px;
      width: 90%;
      max-width: 600px;
      max-height: calc(100vh - 40px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.15);
      animation: slideDown 0.3s ease-out;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      margin: auto;
    } */

    .overlay-content {
  background: #fff;
  border-radius: var(--radius);
  padding: 30px;
  width: 90%;
  max-width: 600px;
  /* REMOVED max-height and overflow to allow natural scrolling */
  box-shadow: 0 10px 30px rgba(0,0,0,0.15);
  animation: slideDown 0.3s ease-out;
  display: flex;
  flex-direction: column;
  margin: auto;
}
    @keyframes slideDown {
      from {transform: translateY(-30px); opacity:0;}
      to {transform: translateY(0); opacity:1;}
    }
    .overlay h3 {
      margin-top: 0;
      margin-bottom: 20px;
      color: var(--darkgreen);
      text-align: center;
      flex-shrink: 0;
    }
    .form-group {margin-bottom: 15px;}
    .form-group label {display:block; font-weight:600; margin-bottom:5px; color:var(--text);}
    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 14px;
      transition: var(--transition);
    }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      border-color: var(--darkgreen);
      outline: none;
      box-shadow: 0 0 0 2px rgba(0, 83, 63, 0.2);
    }
    .form-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #eee;
      flex-shrink: 0;
    }

    /* ===== Profile Dropdown ===== */
    .profile-dropdown{
      position:absolute;
      top:60px;
      right:20px;
      width:220px;
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      display:none;
      flex-direction:column;
      padding:12px;
      z-index:100;
    }
    .profile-header{
      display:flex;
      align-items:center;
      gap:10px;
      margin-bottom:12px;
      padding-bottom:12px;
      border-bottom:1px solid #eee;
    }
    .profile-header img{
      width:50px;
      height:50px;
      border-radius:50%;
      object-fit:cover;
      border:2px solid var(--darkgreen);
    }
    .profile-header strong{
      font-size:14px;
      color:var(--darkgreen);
    }
    .profile-header div{
      font-size:12px;
      color:var(--muted);
    }
    .profile-actions .btn{
      width:100%;
      margin-bottom:6px;
      font-size:13px;
      justify-content:center;
    }

    /* ===== Employee Details Modal ===== */
    .employee-modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 2000;
      overflow-y: auto;
      padding: 20px 0;
    }
    .employee-modal.active {
      display: block;
    }
    .modal-container {
      background: #fff;
      border-radius: var(--radius);
      padding: 30px;
      width: 90%;
      max-width: 900px;
      margin: 20px auto;
      box-shadow: 0 10px 30px rgba(0,0,0,0.15);
      position: relative;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #eee;
    }
    .modal-title {
      color: var(--darkgreen);
      font-size: 24px;
      font-weight: 700;
    }
    .close-modal {
      background: none;
      border: none;
      font-size: 24px;
      color: var(--muted);
      cursor: pointer;
      transition: var(--transition);
    }
    .close-modal:hover {
      color: var(--red);
    }
    .section-card {
      background: #f9fbf9;
      border: 1px solid #e0f0e9;
      border-radius: 10px;
      margin-bottom: 20px;
      padding: 20px;
    }
    .section-header {
      background: linear-gradient(to right, var(--darkgreen), var(--lightgreen));
      color: white;
      padding: 8px 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      font-size: 18px;
      font-weight: 600;
    }
    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
    }
    .info-item {
      display: flex;
      flex-direction: column;
    }
    .info-label {
      font-weight: 600;
      color: var(--darkgreen);
      margin-bottom: 5px;
      font-size: 14px;
    }
    .info-value {
      padding: 8px 12px;
      background: #fff;
      border-radius: 6px;
      border: 1px solid #e0e0e0;
    }
    .info-value.editing {
      border-color: var(--darkgreen);
      box-shadow: 0 0 0 2px rgba(0, 83, 63, 0.2);
    }
    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 20px;
    }

    /* ===== Comments Section ===== */
    .comments-section {
      margin-top: 20px;
    }
    .comment-item {
      background: #f9f9f9;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 10px;
    }
    .comment-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
    }
    .comment-author {
      font-weight: 600;
      color: var(--darkgreen);
    }
    .comment-time {
      font-size: 12px;
      color: var(--muted);
    }
    .comment-text {
      font-size: 14px;
    }
    .add-comment {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
    .add-comment input {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }

    /* ===== Status Update Modal ===== */
    .status-update-modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 3000;
      justify-content: center;
      align-items: center;
    }
    .status-update-modal.active {
      display: flex;
    }
    .status-update-content {
      background: #fff;
      border-radius: var(--radius);
      padding: 30px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    }

    /* ===== Multi-step Form ===== */
    .step-indicator {
      display: flex;
      justify-content: center;
      margin-bottom: 25px;
      flex-shrink: 0;
    }
    .step {
      display: flex;
      align-items: center;
    }
    .step-number {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: #e0e0e0;
      color: #666;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      margin: 0 5px;
    }
    .step.active .step-number {
      background: var(--darkgreen);
      color: white;
    }
    .step.completed .step-number {
      background: var(--lightgreen);
      color: white;
    }
    .step-line {
      width: 50px;
      height: 2px;
      background: #e0e0e0;
    }
    .step.completed .step-line {
      background: var(--lightgreen);
    }
    /* .step-content {
      display: none;
      overflow-y: auto;
      overflow-x: hidden;
      flex: 1;
      padding-right: 10px;
      max-height: calc(100vh - 280px);
    } */

    .step-content {
  display: none;
  overflow-y: auto; /* Allow scrolling within the step */
  flex: 1; /* Allow it to take up available space */
  padding-right: 10px;
  /* REMOVED max-height to let it grow naturally */
}
    .step-content.active {
      display: block;
    }
    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 15px;
    }
    .form-section-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--darkgreen);
      margin-bottom: 15px;
      padding-bottom: 8px;
      border-bottom: 1px solid #eee;
    }
    .form-subsection {
      margin-bottom: 20px;
      padding: 15px;
      background: #f9f9f9;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
    }
    .form-subsection-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--darkgreen);
      margin-bottom: 12px;
    }

    /* ===== Responsive ===== */
    @media(max-width:768px){
      .main-nav{display:none}
      .quick-actions{flex-direction:column}
      .btn{width:100%}
      .info-grid {
        grid-template-columns: 1fr;
      }
      .form-row {
        grid-template-columns: 1fr;
      }
      .overlay-content {
        max-width: 95%;
        padding: 20px;
      }
      .step-content {
        max-height: calc(100vh - 220px);
      }
    }
  </style>
  </head>
  <body>

  <!-- Topbar -->
  <header class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <img src="./company_logo.jpg" alt="Logo">
        <span>NEO TECH Solutions</span>
      </div>
      <nav class="main-nav">
        <a href="dashaboard.html" class="nav-link active" data-page="dashboard">Dashboard</a>
        <a href="./employee.html" class="nav-link" data-page="employees">Employees</a>
        <a href="./requsition.html" class="nav-link" data-page="requisitions">Requisitions</a>
        <a href="./company_profile.html" class="nav-link" data-page="company">Company Profile</a>
        <a href="./profile.html" class="nav-link" data-page="profile">My Profile</a>
      </nav>
      <div class="avatar" id="user-avatar"></div>
    </div>
  </header>

  <!-- Profile Dropdown -->
  <div class="profile-dropdown" id="profile-dropdown">
    <div class="profile-header">
      <img src="https://picsum.photos/seed/profile/50/50.jpg" alt="Profile Image" id="profile-img">
      <div>
        <strong id="profile-name">User</strong>
        <div id="profile-role">Role</div>
      </div>
    </div>
    <div class="profile-actions">
      <button class="btn small primary" id="edit-profile-btn">Edit Profile</button>
      <button class="btn small ghost" id="logout-btn">Logout</button>
    </div>
  </div>

  <main class="container">

    <!-- Quick Actions -->
    <section class="quick-actions" id="quick-actions">
      <!-- dynamically populated based on role -->
    </section>

    <!-- Summary Cards -->
    <div class="cards-grid" id="cards-grid"></div>

    <!-- Employees Table -->
    <section class="panel" id="employees-panel">
      <div class="panel-head">
        <h3>Company Employees</h3>
        <input type="text" id="employee-search" class="search-box" placeholder="Search employees...">
      </div>
      <table class="table" id="employees-table">
        <thead>
          <tr>
            <th>Name</th>
            <th>Email</th>
            <th>Role</th>
            <th>Manager</th>
             <th>Department</th>
        <th>Designation</th>
            <th class="text-right">Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- Requisitions Table -->
    <section class="panel" id="requisitions-panel">
      <div class="panel-head">
        <h3>Job Requisitions</h3>
        <select id="status-filter" class="search-box">
          <option value="">All Status</option>
          <option value="Received">Received</option>
          <option value="In-Process">In-Process</option>
          <option value="Fulfilled">Fulfilled</option>
          <option value="Cancelled">Cancelled</option>
        </select>
      </div>
      <table class="table" id="requisitions-table">
        <thead>
          <tr>
            <th>Job Title</th>
            <th>Submitted By</th>
            <th>Status</th>
            <th class="text-right">Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

  </main>

  <!-- Multi-step Add Employee Modal -->
  <div id="addEmployeeModal" class="overlay">
    <div class="overlay-content">
      <h3>Add New Employee</h3>
      
      <!-- Step Indicator -->
      <div class="step-indicator">
        <div class="step active" id="step1-indicator">
          <div class="step-number">1</div>
        </div>
        <div class="step-line"></div>
        <div class="step" id="step2-indicator">
          <div class="step-number">2</div>
        </div>
        <div class="step-line"></div>
        <div class="step" id="step3-indicator">
          <div class="step-number">3</div>
        </div>
        <div class="step-line"></div>
        <div class="step" id="step4-indicator">
          <div class="step-number">4</div>
        </div>
      </div>
      
      <form id="addEmployeeForm">
        <!-- Step 1: Basic Information -->
        <div class="step-content active" id="step1">
          <div class="form-section-title">Basic Information</div>
          <div class="form-row">
            <div class="form-group">
              <label for="employeeName">Name</label>
              <input type="text" id="employeeName" required placeholder="Enter employee name">
            </div>
            <div class="form-group">
              <label for="employeeEmail">Email</label>
              <input type="email" id="employeeEmail" required placeholder="Enter email">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="employeeRole">Role</label>
              <select id="employeeRole" required>
                <option value="">Select Role</option>
                <option value="Management">Management</option>
                <option value="Manager">Manager</option>
                <option value="Employee">Employee</option>
              </select>
            </div>
            <div class="form-group">
              <label for="employeeManager">Manager</label>
              <select id="employeeManager">
                <option value="">None</option>
              </select>
            </div>
          </div>
        </div>
        
        <!-- Step 2: Work Information -->
        <div class="step-content" id="step2">
          <div class="form-section-title">Work Information</div>
          <div class="form-row">
            <div class="form-group">
              <label for="workLocation">Work Location</label>
              <input type="text" id="workLocation" placeholder="Enter work location">
            </div>
            <div class="form-group">
              <label for="workAddress">Work Address</label>
              <input type="text" id="workAddress" placeholder="Enter work address">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="workEmail">Work Email</label>
              <input type="email" id="workEmail" placeholder="Enter work email">
            </div>
            <div class="form-group">
              <label for="workPhone">Work Phone</label>
              <input type="tel" id="workPhone" placeholder="Enter work phone">
            </div>
          </div>
        </div>
        
        <!-- Step 3: Personal Information -->
        <div class="step-content" id="step3">
          <div class="form-section-title">Personal Information</div>
          
          <!-- Basic Personal Details -->
          <div class="form-subsection">
            <div class="form-subsection-title">Basic Details</div>
            <div class="form-row">
              <div class="form-group">
                <label for="gender">Gender</label>
                <select id="gender">
                  <option value="">Select Gender</option>
                  <option value="Male">Male</option>
                  <option value="Female">Female</option>
                  <option value="Other">Other</option>
                </select>
              </div>
              <div class="form-group">
                <label for="dob">Date of Birth</label>
                <input type="date" id="dob">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="address">Address</label>
                <input type="text" id="address" placeholder="Enter address">
              </div>
              <div class="form-group">
                <label for="personalPhone">Phone Number</label>
                <input type="tel" id="personalPhone" placeholder="Enter phone number">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="personalEmail">Email Address</label>
                <input type="email" id="personalEmail" placeholder="Enter personal email">
              </div>
              <div class="form-group">
                <label for="maritalStatus">Marital Status</label>
                <select id="maritalStatus">
                  <option value="">Select Status</option>
                  <option value="Single">Single</option>
                  <option value="Married">Married</option>
                  <option value="Divorced">Divorced</option>
                  <option value="Widowed">Widowed</option>
                </select>
              </div>
            </div>
          </div>
          
          <!-- Family Details -->
          <div class="form-subsection">
            <div class="form-subsection-title">Family Details</div>
            <div class="form-row">
              <div class="form-group">
                <label for="fatherName">Father's Name</label>
                <input type="text" id="fatherName" placeholder="Enter father's name">
              </div>
              <div class="form-group">
                <label for="motherName">Mother's Name</label>
                <input type="text" id="motherName" placeholder="Enter mother's name">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="spouseName">Spouse's Name</label>
                <input type="text" id="spouseName" placeholder="Enter spouse's name">
              </div>
              <div class="form-group">
                <label for="childrenCount">Number of Children</label>
                <input type="number" id="childrenCount" min="0" placeholder="Enter number of children">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="child1Name">Child 1's Name</label>
                <input type="text" id="child1Name" placeholder="Enter child 1's name">
              </div>
              <div class="form-group">
                <label for="child2Name">Child 2's Name</label>
                <input type="text" id="child2Name" placeholder="Enter child 2's name">
              </div>
            </div>
          </div>
          
          <!-- Identification Documents -->
          <div class="form-subsection">
            <div class="form-subsection-title">Identification Documents</div>
            <div class="form-row">
              <div class="form-group">
                <label for="aadhar">Aadhar Card Number</label>
                <input type="text" id="aadhar" placeholder="Enter Aadhar number">
              </div>
              <div class="form-group">
                <label for="pan">Pan Number</label>
                <input type="text" id="pan" placeholder="Enter PAN number">
              </div>
            </div>
          </div>
          
          <!-- Financial Information -->
          <div class="form-subsection">
            <div class="form-subsection-title">Financial Information</div>
            <div class="form-row">
              <div class="form-group">
                <label for="uan">UAN Number</label>
                <input type="text" id="uan" placeholder="Enter UAN number">
              </div>
              <div class="form-group">
                <label for="pf">PF Number</label>
                <input type="text" id="pf" placeholder="Enter PF number">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="bankAccount">Bank Account Number</label>
                <input type="text" id="bankAccount" placeholder="Enter bank account number">
              </div>
              <div class="form-group">
                <label for="bankBranch">Bank Branch</label>
                <input type="text" id="bankBranch" placeholder="Enter bank branch">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="bankIfsc">Bank IFSC Code</label>
                <input type="text" id="bankIfsc" placeholder="Enter IFSC code">
              </div>
            </div>
          </div>
          
          <!-- Education Information -->
          <div class="form-subsection">
            <div class="form-subsection-title">Education Information</div>
            <div class="form-row">
              <div class="form-group">
                <label for="certificateLevel">Certificate Level</label>
                <input type="text" id="certificateLevel" placeholder="Enter certificate level">
              </div>
              <div class="form-group">
                <label for="fieldStudy">Field of Study</label>
                <input type="text" id="fieldStudy" placeholder="Enter field of study">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="schoolName">School Name</label>
                <input type="text" id="schoolName" placeholder="Enter school name">
              </div>
              <div class="form-group">
                <label for="education">Educational Qualification</label>
                <input type="text" id="education" placeholder="Enter educational qualification">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="doj">Date of Joining</label>
                <input type="date" id="doj">
              </div>
            </div>
          </div>
        </div>
        
        <!-- Step 4: HR Information -->
        <div class="step-content" id="step4">
          <div class="form-section-title">HR Information</div>
          <div class="form-row">
            <div class="form-group">
              <label for="empId">Employee ID</label>
              <input type="text" id="empId" placeholder="Enter employee ID">
            </div>
            <div class="form-group">
              <label for="department">Department</label>
              <input type="text" id="department" placeholder="Enter department">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="designation">Designation</label>
              <input type="text" id="designation" placeholder="Enter designation">
            </div>
            <div class="form-group">
              <label for="empType">Employment Type</label>
              <select id="empType">
                <option value="">Select Type</option>
                <option value="Full-time">Full-time</option>
                <option value="Part-time">Part-time</option>
                <option value="Contract">Contract</option>
                <option value="Intern">Intern</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="bloodGroup">Blood Group</label>
              <select id="bloodGroup">
                <option value="">Select Blood Group</option>
                <option value="A+">A+</option>
                <option value="A-">A-</option>
                <option value="B+">B+</option>
                <option value="B-">B-</option>
                <option value="AB+">AB+</option>
                <option value="AB-">AB-</option>
                <option value="O+">O+</option>
                <option value="O-">O-</option>
              </select>
            </div>
            <div class="form-group">
              <label for="ctc">CTC</label>
              <input type="text" id="ctc" placeholder="Enter CTC">
            </div>
          </div>
        </div>
        
        <div class="form-buttons">
          <button type="button" class="btn ghost" id="prevBtn" style="display:none;">Previous</button>
          <button type="button" class="btn primary" id="nextBtn">Next</button>
          <button type="submit" class="btn primary" id="submitBtn" style="display:none;">Add Employee</button>
          <button type="button" class="btn ghost" id="cancelBtn">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Add Requisition Modal -->
  <!-- <div id="addRequisitionModal" class="overlay">
    <div class="overlay-content">
      <h3>Post Job Requisition</h3>
      <form id="addRequisitionForm">
        <div class="form-group">
          <label for="requisitionTitle">Job Title</label>
          <input type="text" id="requisitionTitle" required placeholder="Enter job title">
        </div>
        <div class="form-group">
          <label for="requisitionDescription">Job Description</label>
          <textarea id="requisitionDescription" rows="4" placeholder="Enter job description"></textarea>
        </div>
        <div class="form-group">
          <label for="requisitionDepartment">Department</label>
          <input type="text" id="requisitionDepartment" required placeholder="Enter department">
        </div>
        <div class="form-group">
          <label for="requisitionStatus">Status</label>
          <select id="requisitionStatus" required>
            <option value="Received">Received</option>
            <option value="In-Process">In-Process</option>
            <option value="Fulfilled">Fulfilled</option>
            <option value="Cancelled">Cancelled</option>
          </select>
        </div>
        <div class="form-buttons">
          <button type="submit" class="btn primary">Post Requisition</button>
          <button type="button" class="btn ghost" id="cancelAddRequisition">Cancel</button>
        </div>
      </form>
    </div>
  </div> -->

  <!-- Add Requisition Modal -->
<div id="addRequisitionModal" class="overlay">
  <div class="overlay-content">
    <h3>Post Job Requisition</h3>
    <form id="addRequisitionForm">
      <div class="form-group">
        <label for="requisitionTitle">Job Title</label>
        <input type="text" id="requisitionTitle" required placeholder="Enter job title">
      </div>
      <div class="form-group">
        <label for="requisitionDescription">Job Description</label>
        <textarea id="requisitionDescription" rows="4" placeholder="Enter job description"></textarea>
      </div>
      <div class="form-group">
        <label for="requisitionDepartment">Department</label>
        <input type="text" id="requisitionDepartment" required placeholder="Enter department">
      </div>
      <div class="form-group">
        <label for="requisitionStatus">Status</label>
        <select id="requisitionStatus" required>
          <!-- FIX: Update these values to match backend -->
          <option value="pending">Received</option>
          <option value="approved">Fulfilled</option>
          <option value="rejected">Cancelled</option>
        </select>
      </div>
      
      <!-- ADD THESE NEW FIELDS -->
      <div class="form-group">
        <label for="requisitionLocation">Location</label>
        <input type="text" id="requisitionLocation" placeholder="Enter location">
      </div>
      <div class="form-group">
        <label for="requisitionJobType">Job Type</label>
        <select id="requisitionJobType">
          <option value="full_time">Full Time</option>
          <option value="part_time">Part Time</option>
          <option value="contract">Contract</option>
        </select>
      </div>
      <div class="form-group">
        <label for="requisitionVacancies">Vacancies</label>
        <input type="number" id="requisitionVacancies" value="1" min="1">
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="requisitionMinExp">Min Experience (years)</label>
          <input type="number" id="requisitionMinExp" value="0" min="0">
        </div>
        <div class="form-group">
          <label for="requisitionMaxExp">Max Experience (years)</label>
          <input type="number" id="requisitionMaxExp" value="5" min="0">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="requisitionMinSalary">Min Salary</label>
          <input type="number" id="requisitionMinSalary" value="0" min="0">
        </div>
        <div class="form-group">
          <label for="requisitionMaxSalary">Max Salary</label>
          <input type="number" id="requisitionMaxSalary" value="100000" min="0">
        </div>
      </div>
      <div class="form-group">
        <label for="requisitionRequirements">Requirements</label>
        <textarea id="requisitionRequirements" rows="3" placeholder="Enter job requirements"></textarea>
      </div>
      <div class="form-group">
        <label for="requisitionSkills">Skills Required</label>
        <input type="text" id="requisitionSkills" placeholder="Enter required skills">
      </div>
      
      <div class="form-buttons">
        <button type="submit" class="btn primary">Post Requisition</button>
        <button type="button" class="btn ghost" id="cancelAddRequisition">Cancel</button>
      </div>
    </form>
  </div>
</div>

  <!-- Status Update Modal -->
  <div id="statusUpdateModal" class="status-update-modal">
    <div class="status-update-content">
      <h3>Update Requisition Status</h3>
      <form id="statusUpdateForm">
        <div class="form-group">
          <label for="newStatus">New Status</label>
          <select id="newStatus" required>
            <option value="Received">Received</option>
            <option value="In-Process">In-Process</option>
            <option value="Fulfilled">Fulfilled</option>
            <option value="Cancelled">Cancelled</option>
          </select>
        </div>
        <div class="form-buttons">
          <button type="submit" class="btn primary">Update Status</button>
          <button type="button" class="btn ghost" id="cancelStatusUpdate">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Employee Details Modal -->
  <div id="employeeDetailsModal" class="employee-modal">
    <div class="modal-container">
      <div class="modal-header">
        <h2 class="modal-title">Employee Details</h2>
        <button class="close-modal" id="closeEmployeeModal">&times;</button>
      </div>

      <!-- Work Information -->
      <div class="section-card">
        <h3 class="section-header">Work Information</h3>
        <div class="info-grid">
          <div class="info-item">
            <div class="info-label">Name</div>
            <div class="info-value" id="detail-name"></div>
          </div>
          <div class="info-item">
            <div class="info-label">Work Location</div>
            <div class="info-value" id="detail-location"></div>
          </div>
          <div class="info-item">
            <div class="info-label">Work Address</div>
            <div class="info-value" id="detail-work-address"></div>
          </div>
          <div class="info-item">
            <div class="info-label">Manager</div>
            <div class="info-value" id="detail-manager"></div>
          </div>
          <div class="info-item">
            <div class="info-label">Work Email</div>
            <div class="info-value" id="detail-email"></div>
          </div>
          <div class="info-item">
            <div class="info-label">Work Phone</div>
            <div class="info-value" id="detail-phone"></div>
          </div>
        </div>
      </div>

      <!-- Personal Information -->
      <div class="section-card">
        <h3 class="section-header">Personal Information</h3>
        <div class="info-grid">
          <div class="info-item">
            <div class="info-label">Gender</div>
            <div class="info-value" id="detail-gender"></div>
          </div>
          <div class="info-item">
            <div class="info-label">Date of Birth</div>
            <div class="info-value" id="detail-dob"></div>
          </div>
          <div class="info-item">
            <div class="info-label">Address</div>
            <div class="info-value" id="detail-address"></div>
          </div>
          <div class="info-item">
            <div class="info-label">Phone Number</div>
            <div class="info-value" id="detail-personal-phone"></div>
          </div>
          <div class="info-item">
            <div class="info-label">Email Address</div>
            <div class="info-value" id="detail-personal-email"></div>
          </div>
          <div class="info-item">
            <div class="info-label">Aadhar Card Number</div>
            <div class="info-value" id="detail-aadhar"></div>
          </div>
          <div class="info-item">
            <div class="info-label">Pan Number</div>
            <div class="info-value" id="detail-pan"></div>
          </div>
          <div class="info-item">
            <div class="info-label">UAN Number</div>
            <div class="info-value" id="detail-uan"></div>
          </div>
          <div class="info-item">
            <div class="info-label">PF Number</div>
            <div class="info-value" id="detail-pf"></div>
          </div>
          <div class="info-item">
            <div class="info-label">Bank Account Number</div>
            <div class="info-value" id="detail-bank-account"></div>
          </div>
          <div class="info-item">
            <div class="info-label">Bank Branch</div>
            <div class="info-value" id="detail-bank-branch"></div>
          </div>
          <div class="info-item">
            <div class="info-label">Bank IFSC Code</div>
            <div class="info-value" id="detail-bank-ifsc"></div>
          </div>
          <div class="info-item">
            <div class="info-label">Father's Name</div>
            <div class="info-value" id="detail-father-name"></div>
          </div>
          <div class="info-item">
            <div class="info-label">Mother's Name</div>
            <div class="info-value" id="detail-mother-name"></div>
          </div>
          <div class="info-item">
            <div class="info-label">Marital Status</div>
            <div class="info-value" id="detail-marital-status"></div>
          </div>
          <div class="info-item">
            <div class="info-label">Spouse's Name</div>
            <div class="info-value" id="detail-spouse-name"></div>
          </div>
          <div class="info-item">
            <div class="info-label">Number of Children</div>
            <div class="info-value" id="detail-children-count"></div>
          </div>
          <div class="info-item">
            <div class="info-label">Child 1's Name</div>
            <div class="info-value" id="detail-child1-name"></div>
          </div>
          <div class="info-item">
            <div class="info-label">Child 2's Name</div>
            <div class="info-value" id="detail-child2-name"></div>
          </div>
          <div class="info-item">
            <div class="info-label">Certificate Level</div>
            <div class="info-value" id="detail-certificate-level"></div>
          </div>
          <div class="info-item">
            <div class="info-label">Field of Study</div>
            <div class="info-value" id="detail-field-study"></div>
          </div>
          <div class="info-item">
            <div class="info-label">School Name</div>
            <div class="info-value" id="detail-school-name"></div>
          </div>
          <div class="info-item">
            <div class="info-label">Educational Qualification</div>
            <div class="info-value" id="detail-education"></div>
          </div>
        </div>
      </div>

      <!-- HR Information -->
      <div class="section-card">
        <h3 class="section-header">HR Information</h3>
        <div class="info-grid">
          <div class="info-item">
            <div class="info-label">Employee ID</div>
            <div class="info-value" id="detail-empId"></div>
          </div>
          <div class="info-item">
            <div class="info-label">Department</div>
            <div class="info-value" id="detail-department"></div>
          </div>
          <div class="info-item">
            <div class="info-label">Designation</div>
            <div class="info-value" id="detail-designation"></div>
          </div>
          <div class="info-item">
            <div class="info-label">Date of Joining</div>
            <div class="info-value" id="detail-doj"></div>
          </div>
          <div class="info-item">
            <div class="info-label">Employment Type</div>
            <div class="info-value" id="detail-empType"></div>
          </div>
          <div class="info-item">
            <div class="info-label">Blood Group</div>
            <div class="info-value" id="detail-blood-group"></div>
          </div>
          <div class="info-item">
            <div class="info-label">CTC</div>
            <div class="info-value" id="detail-ctc"></div>
          </div>
        </div>
      </div>

      <!-- Comments Section -->
      <!-- <div class="section-card">
        <h3 class="section-header">Comments</h3>
        <div id="comments-container">
         Comments will be dynamically added here -->
        <!-- </div>
        <div class="add-comment">
          <input type="text" id="new-comment" placeholder="Add a comment...">
          <button class="btn primary" id="add-comment-btn">Add</button>
        </div>
      </div>   -->

      <!-- Comments Section -->
<div class="section-card">
    <h3 class="section-header">Comments</h3>
    <div id="comments-container">
        <!-- Comments will be dynamically added here -->
    </div>
    <div class="add-comment">
        <input type="text" id="new-comment" placeholder="Add a comment...">
        <button class="btn primary" id="add-comment-btn">Add</button>
    </div>
</div>

      <div class="modal-actions">
        <button class="btn primary" id="edit-employee-btn">Edit</button>
        <button class="btn success" id="save-employee-btn" style="display:none;">Save</button>
        <button class="btn ghost" id="cancel-edit-btn" style="display:none;">Cancel</button>
        <button class="btn danger" id="delete-employee-btn">Delete</button>
      </div>
    </div>
  </div>

  <script>

  let currentUser = {};
  let employees = [];
  let requisitions = [];
  let comments = {};
  let selectedEmployeeIndex = -1;
  let selectedRequisitionIndex = -1;
  let isEditMode = false;
  let currentStep = 1;
  let authToken = '';


  document.addEventListener('DOMContentLoaded', function() {
    authToken = sessionStorage.getItem('authToken');
    const userStr = sessionStorage.getItem('currentUser');
    
    if (!userStr || !authToken) {
      window.location.href = 'login.html';
      return;
    }
    
    currentUser = JSON.parse(userStr);
    initializeApp();
  });

  async function initializeApp() {
    setupUI();
    
    if (currentUser.user_type === 'Employee') {
      await loadEmployeeProfile();
      showEmployeeProfileOnly();
    } else {
      console.log('Current user:', currentUser);
      console.log('Auth token:', authToken);
      await loadDashboardData();
      console.log('Employees loaded:', employees);
      console.log('Requisitions loaded:', requisitions);
      renderQuickActions();
      renderCards();
      renderEmployeesTable();
      renderRequisitionsTable();
      setupEventListeners();
    }
  }



 
  async function loadDashboardData() {
    try {
        // --- STEP 1: Get current user details (This is fine) ---
        console.log('>>> Fetching current user from /api/users/me');
        const userResponse = await fetchWithAuth('/api/users/me');
        if (userResponse.ok) {
            const userData = await userResponse.json();
            currentUser = userData;
            sessionStorage.setItem('currentUser', JSON.stringify(userData));
        } else {
            console.error('>>> FAILED: Could not get current user. Status:', userResponse.status);
            return;
        }

        // --- STEP 2: Load employees using the CORRECT endpoint ---
        console.log('>>> Fetching employees from /api/company/employees/');
        const usersResponse = await fetchWithAuth('/api/company/employees/');
        if (usersResponse.ok) {
            const employeesData = await usersResponse.json();
            console.log('>>> SUCCESS: Employees from API:', employeesData);

            // The backend already returns the correct list. No need to filter again.
            // Just handle pagination if it exists.
            if (Array.isArray(employeesData)) {
                employees = employeesData;
            } else if (employeesData.results && Array.isArray(employeesData.results)) {
                employees = employeesData.results;
            } else {
                employees = [];
            }

        } else {
            console.error('>>> FAILED: Could not load employees. Status:', usersResponse.status);
            employees = [];
        }

        // --- STEP 3: Load requisitions (This part is okay) ---
        let requisitionsUrl;
        if (currentUser.user_type === 'hr_admin') {
            requisitionsUrl = '/api/hr/requisitions/';
        } else {
            requisitionsUrl = '/api/requisitions/';
        }
        
        const requisitionsResponse = await fetchWithAuth(requisitionsUrl);
        if (requisitionsResponse && requisitionsResponse.ok) {
            const requisitionsData = await requisitionsResponse.json();
            if (Array.isArray(requisitionsData)) {
                requisitions = requisitionsData;
            } else if (requisitionsData.results && Array.isArray(requisitionsData.results)) {
                requisitions = requisitionsData.results;
            } else {
                requisitions = [];
            }
        } else {
            requisitions = [];
        }

    } catch (error) {
        console.error('>>> CATCH: A critical error occurred in loadDashboardData:', error);
        employees = [];
        requisitions = [];
    }
}

 


  async function loadCompanyAdminData() {
    try {
      // Load current user
      const userResponse = await fetchWithAuth('/api/users/me');
      if (userResponse.ok) {
        const userData = await userResponse.json();
        currentUser = userData;
        sessionStorage.setItem('currentUser', JSON.stringify(userData));
      }

      // Load all users
      const usersResponse = await fetchWithAuth('/api/users/');
      if (usersResponse.ok) {
        const allUsers = await usersResponse.json();
        console.log('All users:', allUsers);
        employees = Array.isArray(allUsers) ? allUsers : [];
      }

      // For company admin, use regular requisitions endpoint
      const requisitionsResponse = await fetchWithAuth('/api/requisitions/');
      if (requisitionsResponse.ok) {
        const allRequisitions = await requisitionsResponse.json();
        console.log('All requisitions:', allRequisitions);
        requisitions = Array.isArray(allRequisitions) ? allRequisitions : [];
      }
    } catch (error) {
      console.error('Error loading company admin data:', error);
      employees = [];
      requisitions = [];
    }
  }

  async function loadHRAdminData() {
    try {
      // Load current user
      const userResponse = await fetchWithAuth('/api/users/me');
      if (userResponse.ok) {
        const userData = await userResponse.json();
        currentUser = userData;
        sessionStorage.setItem('currentUser', JSON.stringify(userData));
      }

      // Load all users
      const usersResponse = await fetchWithAuth('/api/users/');
      if (usersResponse.ok) {
        const allUsers = await usersResponse.json();
        employees = Array.isArray(allUsers) ? allUsers : [];
      }

      // HR admin can use the hr/requisitions endpoint
      const requisitionsResponse = await fetchWithAuth('/api/hr/requisitions/');
      if (requisitionsResponse.ok) {
        const allRequisitions = await requisitionsResponse.json();
        requisitions = Array.isArray(allRequisitions) ? allRequisitions : [];
      }
    } catch (error) {
      console.error('Error loading HR admin data:', error);
      employees = [];
      requisitions = [];
    }
  }

  async function loadCorporateData() {
    try {
      // Load current user
      const userResponse = await fetchWithAuth('/api/users/me');
      if (userResponse.ok) {
        const userData = await userResponse.json();
        currentUser = userData;
        sessionStorage.setItem('currentUser', JSON.stringify(userData));
      }

      // Load all users
      const usersResponse = await fetchWithAuth('/api/users/');
      if (usersResponse.ok) {
        const allUsers = await usersResponse.json();
        const companyUsers = Array.isArray(allUsers) ? allUsers.filter(user => user.company === currentUser.company) : [];
        
        if (currentUser.user_type === 'management') {
          employees = companyUsers;
        } else if (currentUser.user_type === 'supervisor') {
          employees = companyUsers.filter(user => user.manager === currentUser.id);
        }
      }

      // Use regular requisitions endpoint
      const requisitionsResponse = await fetchWithAuth('/api/requisitions/');
      if (requisitionsResponse.ok) {
        const allRequisitions = await requisitionsResponse.json();
        requisitions = Array.isArray(allRequisitions) ? allRequisitions.filter(req => req.company === currentUser.company) : [];
      }
    } catch (error) {
      console.error('Error loading corporate data:', error);
      employees = [];
      requisitions = [];
    }
  }

  // In dashboard.html

function fetchWithAuth(url, options = {}) {
    const defaultOptions = {
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Token ${authToken}`
        }
    };
    
    // --- FIX: Ensure URL ends with a slash for all methods except DELETE ---
    // This is the standard and correct way to handle Django's APPEND_SLASH=True
    if (!url.endsWith('/')) {
        url = url + '/';
    }
    
    const fullUrl = `http://127.0.0.1:8000${url}`;
    
    console.log('Making request to:', fullUrl);
    console.log('Auth token:', authToken ? 'Present' : 'Missing');
    
    return fetch(fullUrl, {
        ...defaultOptions,
        ...options
    }).then(async response => {
        console.log('Response status:', response.status, 'for URL:', url);
        
        if (!response.ok) {
            let errorText;
            try {
                errorText = await response.text();
                console.error('Error response body:', errorText);
            } catch (e) {
                console.error('Could not parse error response');
            }
            console.error('Request failed:', response.statusText, 'URL:', url);
        }
        
        return response;
    }).catch(error => {
        console.error('Network error:', error, 'URL:', url);
        throw error;
    });
}


  function setupUI() {
    document.getElementById('profile-name').textContent = currentUser.get_full_name || currentUser.first_name + ' ' + currentUser.last_name || currentUser.email;
    document.getElementById('profile-role').textContent = formatUserRole(currentUser.user_type || currentUser.role);
    document.getElementById('user-avatar').textContent = (currentUser.get_full_name || currentUser.first_name + ' ' + currentUser.last_name || currentUser.email).charAt(0).toUpperCase();
  }

  function formatUserRole(role) {
    const roleMap = {
      'hr_admin': 'HR Admin',
      'company_admin': 'Company Admin', 
      'management': 'Management',
      'supervisor': 'Supervisor',
      'employee': 'Employee',
      'candidate': 'Candidate'
    };
    return roleMap[role] || role || 'Unknown';
  }

  function renderQuickActions() {
    const quickActions = document.getElementById('quick-actions');
    quickActions.innerHTML = '';
    
    if (currentUser.user_type === 'hr_admin') {
      quickActions.innerHTML = `
        <button class="btn primary" onclick="showAddCompanyModal()">
          <i class="fas fa-building"></i> Add Company
        </button>
        <button class="btn primary" onclick="showAddUserModal()">
          <i class="fas fa-user-plus"></i> Add User
        </button>
        <button class="btn primary" onclick="window.location.href='./company_profile.html'">
          <i class="fas fa-building"></i> Manage Companies
        </button>
      `;
    } else if (currentUser.user_type === 'company_admin') {
      quickActions.innerHTML = `
        <button class="btn primary" onclick="showAddEmployeeModal()">
          <i class="fas fa-user-plus"></i> Add Employee
        </button>
        <button class="btn primary" onclick="showAddRequisitionModal()">
          <i class="fas fa-briefcase"></i> Post Requisition
        </button>
        <button class="btn primary" onclick="window.location.href='./company_profile.html'">
          <i class="fas fa-building"></i> Edit Company
        </button>
      `;
    } else if (currentUser.user_type === 'management') {
      quickActions.innerHTML = `
        <button class="btn primary" onclick="showAddRequisitionModal()">
          <i class="fas fa-briefcase"></i> Post Requisition
        </button>
        <button class="btn primary" onclick="window.location.href='./employee.html'">
          <i class="fas fa-users"></i> Manage Team
        </button>
      `;
    } else if (currentUser.user_type === 'supervisor') {
      quickActions.innerHTML = `
        <button class="btn primary" onclick="showAddRequisitionModal()">
          <i class="fas fa-briefcase"></i> Post Requisition
        </button>
        <button class="btn primary" onclick="window.location.href='./employee.html'">
          <i class="fas fa-users"></i> My Team
        </button>
      `;
    }
  }

  function renderCards() {
    const cardsGrid = document.getElementById('cards-grid');
    cardsGrid.innerHTML = '';
    
    if (currentUser.user_type === 'employee') {
      const employee = employees.find(e => e.email === currentUser.email) || currentUser;
      cardsGrid.innerHTML = `
        <div class="card">
          <h4>Your Role</h4>
          <div class="big-number">${formatUserRole(employee.role || employee.user_type)}</div>
        </div>
        <div class="card">
          <h4>Department</h4>
          <div class="big-number">${employee.department || 'TBD'}</div>
        </div>
        <div class="card">
          <h4>Manager</h4>
          <div class="big-number">${employee.manager_name || 'None'}</div>
        </div>
        <div class="card">
          <h4>Employment Type</h4>
          <div class="big-number">${employee.employment_type || 'Full-time'}</div>
        </div>
      `;
    } else {
      const stats = window.dashboardStats || {};
      const totalEmployees = employees.length;
      const totalManagers = employees.filter(e => e.role === 'supervisor' || e.user_type === 'supervisor').length;
      const totalRequisitions = requisitions.length;
      const pendingRequisitions = requisitions.filter(r => r.status === 'pending' || r.status === 'Received').length;
      
      cardsGrid.innerHTML = `
        <div class="card">
          <h4>Total Employees</h4>
          <div class="big-number">${totalEmployees}</div>
        </div>
        <div class="card">
          <h4>Total Managers</h4>
          <div class="big-number">${totalManagers}</div>
        </div>
        <div class="card">
          <h4>Total Requisitions</h4>
          <div class="big-number">${totalRequisitions}</div>
        </div>
        <div class="card">
          <h4>Pending Requisitions</h4>
          <div class="big-number">${pendingRequisitions}</div>
        </div>
      `;
    }
  }

  function renderEmployeesTable() {
    const tableBody = document.querySelector('#employees-table tbody');
    if (!tableBody) return;
    
    tableBody.innerHTML = '';
    
    let filteredEmployees = [...employees];
    
    // Apply role-based filtering
    if (currentUser.user_type === 'supervisor') {
        filteredEmployees = filteredEmployees.filter(emp => {
            if (emp.manager) {
                if (typeof emp.manager === 'object') {
                    return emp.manager.id === currentUser.id;
                } else if (typeof emp.manager === 'string' || typeof emp.manager === 'number') {
                    return emp.manager === currentUser.id || emp.manager == currentUser.id;
                }
            }
            return false;
        });
    } else if (currentUser.user_type === 'employee') {
        filteredEmployees = filteredEmployees.filter(emp => emp.id === currentUser.id);
    }
    
    console.log('Final filtered employees:', filteredEmployees);
    
    if (filteredEmployees.length === 0) {
        // Update colspan to match the new number of table columns (7)
        tableBody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:20px;">No employees found</td></tr>';
        return;
    }
    
    filteredEmployees.forEach((employee) => {
        const row = document.createElement('tr');
        
        // Get manager name
        let managerName = 'None';
        if (employee.manager) {
            if (typeof employee.manager === 'object' && employee.manager.first_name) {
                managerName = `${employee.manager.first_name} ${employee.manager.last_name}`;
            } else if (typeof employee.manager === 'string') {
                managerName = employee.manager;
            }
        }
        
        // Get employee name
        let employeeName = employee.email;
        if (employee.first_name && employee.last_name) {
            employeeName = `${employee.first_name} ${employee.last_name}`;
        } else if (employee.get_full_name) {
            employeeName = employee.get_full_name;
        }

        // Access the nested employee_profile object
        const profile = employee.employee_profile || {};
        
        // Find the actual index in the original employees array
        const actualIndex = employees.findIndex(emp => emp.id === employee.id);
        
        row.innerHTML = `
            <td>${employeeName}</td>
            <td>${employee.email}</td>
            <td>${formatUserRole(employee.user_type || employee.role)}</td>
            <td>${managerName}</td>
            <td>${profile.department || 'N/A'}</td>
            <td>${profile.designation || 'N/A'}</td>
            <td class="text-right">
                <button class="btn tiny view-employee-btn" onclick="viewEmployee(${actualIndex})">View</button>
                ${currentUser.user_type === 'hr_admin' || currentUser.user_type === 'company_admin' ? 
                    `<button class="btn tiny danger delete-employee-btn" onclick="deleteEmployee(${actualIndex})">Delete</button>` : ''}
            </td>
        `;
        
        tableBody.appendChild(row);
    });
}

function renderRequisitionsTable() {
    const tableBody = document.querySelector('#requisitions-table tbody');
    if (!tableBody) return;
    
    tableBody.innerHTML = '';
    
    let filteredRequisitions = [...requisitions];
    
    // Filter requisitions based on user role
    if (currentUser.user_type === 'employee') {
        filteredRequisitions = requisitions.filter(req => {
            if (req.submitted_by) {
                // Handle different formats of submitted_by
                if (typeof req.submitted_by === 'object') {
                    return req.submitted_by.id === currentUser.id;
                } else if (typeof req.submitted_by === 'number') {
                    return req.submitted_by === currentUser.id;
                } else if (typeof req.submitted_by === 'string') {
                    // Check if it's the user's email or ID
                    return req.submitted_by === currentUser.id || req.submitted_by === currentUser.email;
                }
            }
            return false;
        });
    } else if (currentUser.user_type !== 'hr_admin') {
        filteredRequisitions = requisitions.filter(req => {
            if (req.company) {
                if (typeof req.company === 'object') {
                    return req.company.id === currentUser.company;
                } else if (typeof req.company === 'number') {
                    return req.company === currentUser.company;
                } else if (typeof req.company === 'string') {
                    return req.company === currentUser.company || req.company === currentUser.company_name;
                }
            }
            return false;
        });
    }
    
    if (filteredRequisitions.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px;">No requisitions found</td></tr>';
        return;
    }
    
    filteredRequisitions.forEach((requisition, filteredIndex) => {
        const row = document.createElement('tr');
        const pillClass = getStatusClass(requisition.status);
        
        // FIXED: Get submitter name - handle ALL possible formats
        let submitterName = 'Unknown';
        if (requisition.submitted_by) {
            // If it's an object with first_name/last_name
            if (typeof requisition.submitted_by === 'object' && requisition.submitted_by.first_name) {
                submitterName = `${requisition.submitted_by.first_name} ${requisition.submitted_by.last_name}`;
            } 
            // If it's an object with get_full_name
            else if (typeof requisition.submitted_by === 'object' && requisition.submitted_by.get_full_name) {
                submitterName = requisition.submitted_by.get_full_name;
            }
            // If it's an object with username
            else if (typeof requisition.submitted_by === 'object' && requisition.submitted_by.username) {
                submitterName = requisition.submitted_by.username;
            }
            // If it's a simple string
            else if (typeof requisition.submitted_by === 'string') {
                submitterName = requisition.submitted_by;
            }
            // If it's an ID, find the user in our employees array
            else if (typeof requisition.submitted_by === 'number') {
                const user = employees.find(emp => emp.id === requisition.submitted_by);
                if (user) {
                    submitterName = user.get_full_name || user.first_name + ' ' + user.last_name || user.email;
                }
            }
        }
        
        // Find the actual index in the original requisitions array
        const actualIndex = requisitions.findIndex(req => req.id === requisition.id);
        
        row.innerHTML = `
            <td>${requisition.job_title || requisition.title || 'N/A'}</td>
            <td>${submitterName}</td>
            <td><span class="pill ${pillClass}">${requisition.status}</span></td>
            <td class="text-right">
                <button class="btn tiny view-employee-btn" onclick="viewRequisition(${actualIndex})">View</button>
                ${currentUser.user_type === 'hr_admin' || currentUser.user_type === 'company_admin' ? 
                    `<button class="btn tiny danger delete-requisition-btn" onclick="deleteRequisition(${actualIndex})">Delete</button>` : ''}
            </td>
        `;
        
        tableBody.appendChild(row);
    });
}

async function viewRequisition(index) {
    const requisition = requisitions[index];
    
    // Create a simple modal to show requisition details
    const modalHtml = `
        <div id="viewRequisitionModal" class="overlay active">
            <div class="overlay-content">
                <h3>Requisition Details</h3>
                <div class="form-group">
                    <label>Job Title</label>
                    <div style="padding: 10px; background: #f5f5f5; border-radius: 5px;">${requisition.job_title || requisition.title || 'N/A'}</div>
                </div>
                <div class="form-group">
                    <label>Department</label>
                    <div style="padding: 10px; background: #f5f5f5; border-radius: 5px;">${requisition.department || 'N/A'}</div>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <div style="padding: 10px; background: #f5f5f5; border-radius: 5px; min-height: 80px;">${requisition.description || 'N/A'}</div>
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <div style="padding: 10px; background: #f5f5f5; border-radius: 5px;">
                        <span class="pill ${getStatusClass(requisition.status)}">${requisition.status}</span>
                    </div>
                </div>
                <div class="form-group">
                    <label>Submitted By</label>
                    <div style="padding: 10px; background: #f5f5f5; border-radius: 5px;">${getSubmitterName(requisition.submitted_by)}</div>
                </div>
                <div class="form-buttons">
                    <button type="button" class="btn ghost" onclick="closeModal('viewRequisitionModal')">Close</button>
                </div>
            </div>
        </div>
    `;
    
    // Add modal to page
    document.body.insertAdjacentHTML('beforeend', modalHtml);
}

// Helper function to get submitter name
function getSubmitterName(submittedBy) {
    if (!submittedBy) return 'Unknown';
    
    if (typeof submittedBy === 'object') {
        if (submittedBy.first_name) {
            return `${submittedBy.first_name} ${submittedBy.last_name}`;
        } else if (submittedBy.get_full_name) {
            return submittedBy.get_full_name;
        } else if (submittedBy.username) {
            return submittedBy.username;
        }
    } else if (typeof submittedBy === 'string') {
        return submittedBy;
    } else if (typeof submittedBy === 'number') {
        const user = employees.find(emp => emp.id === submittedBy);
        if (user) {
            return user.get_full_name || user.first_name + ' ' + user.last_name || user.email;
        }
    }
    
    return 'Unknown';
}

  async function testApiEndpoints() {
    console.log('Testing API endpoints...');
    
    // Test users endpoint
    try {
      const usersResponse = await fetchWithAuth('/api/users/');
      console.log('Users endpoint status:', usersResponse.status);
      if (usersResponse.ok) {
        const usersData = await usersResponse.json();
        console.log('Users data:', usersData);
      }
    } catch (error) {
      console.error('Users endpoint error:', error);
    }
    
    // Test current user endpoint - fix the URL
    try {
      const userResponse = await fetchWithAuth('/api/users/me');
      console.log('Current user endpoint status:', userResponse.status);
      if (userResponse.ok) {
        const userData = await userResponse.json();
        console.log('Current user data:', userData);
      }
    } catch (error) {
      console.error('Current user endpoint error:', error);
    }
    
    // Test requisitions endpoint
    try {
      const requisitionsResponse = await fetchWithAuth('/api/requisitions/');
      console.log('Requisitions endpoint status:', requisitionsResponse.status);
      if (requisitionsResponse.ok) {
        const requisitionsData = await requisitionsResponse.json();
        console.log('Requisitions data:', requisitionsData);
      }
    } catch (error) {
      console.error('Requisitions endpoint error:', error);
    }
    
    // Test HR requisitions endpoint
    try {
      const hrRequisitionsResponse = await fetchWithAuth('/api/hr/requisitions/');
      console.log('HR requisitions endpoint status:', hrRequisitionsResponse.status);
      if (hrRequisitionsResponse.ok) {
        const hrRequisitionsData = await hrRequisitionsResponse.json();
        console.log('HR requisitions data:', hrRequisitionsData);
      }
    } catch (error) {
      console.error('HR requisitions endpoint error:', error);
    }
  }

  // Call this function at the beginning of initializeApp
  async function initializeApp() {
    setupUI();
    
    
    if (currentUser.user_type === 'Employee') {
      await loadEmployeeProfile();
      showEmployeeProfileOnly();
    } else {
      console.log('Current user:', currentUser);
      console.log('Auth token:', authToken);
      await loadDashboardData();
      console.log('Employees loaded:', employees);
      console.log('Requisitions loaded:', requisitions);
      renderQuickActions();
      renderCards();
      renderEmployeesTable();
      renderRequisitionsTable();
      setupEventListeners();
    }
  }


  function getStatusClass(status) {
    const statusMap = {
      'pending': 'received',
      'approved': 'fulfilled', 
      'rejected': 'cancelled',
      'received': 'received',
      'in-process': 'in-process',
      'fulfilled': 'fulfilled',
      'cancelled': 'cancelled'
    };
    return statusMap[status] || 'received';
  }

  


  function setupEventListeners() {
    document.getElementById('user-avatar').addEventListener('click', function() {
        document.getElementById('profile-dropdown').style.display = 
            document.getElementById('profile-dropdown').style.display === 'flex' ? 'none' : 'flex';
    });
    
    document.addEventListener('click', function(e) {
        const profileDropdown = document.getElementById('profile-dropdown');
        const avatar = document.getElementById('user-avatar');
        
        if (!profileDropdown.contains(e.target) && e.target !== avatar) {
            profileDropdown.style.display = 'none';
        }
    });
    
    document.getElementById('edit-profile-btn').addEventListener('click', function() {
        window.location.href = 'profile.html';
    });
    
    document.getElementById('logout-btn').addEventListener('click', logout);
    
    document.getElementById('employee-search').addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        const rows = document.querySelectorAll('#employees-table tbody tr');
        
        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(searchTerm) ? '' : 'none';
        });
    });
    
    document.getElementById('status-filter').addEventListener('change', function() {
        const status = this.value;
        const rows = document.querySelectorAll('#requisitions-table tbody tr');
        
        rows.forEach(row => {
            if (status === '') {
                row.style.display = '';
            } else {
                const statusCell = row.querySelector('.pill');
                row.style.display = statusCell && statusCell.textContent.toLowerCase() === status.toLowerCase() ? '' : 'none';
            }
        });
    });
    
    document.getElementById('closeEmployeeModal').addEventListener('click', function() {
        closeModal('employeeDetailsModal');
    });
    
    document.getElementById('edit-employee-btn').addEventListener('click', function() {
        isEditMode = true;
        document.querySelectorAll('.info-value').forEach(element => {
            element.contentEditable = true;
            element.classList.add('editing');
        });
        
        document.getElementById('edit-employee-btn').style.display = 'none';
        document.getElementById('save-employee-btn').style.display = 'inline-block';
        document.getElementById('cancel-edit-btn').style.display = 'inline-block';
    });
document.getElementById('save-employee-btn').addEventListener('click', async function() {
    // Get save button element and store its original text
    const saveButton = document.getElementById('save-employee-btn');
    const originalText = saveButton.textContent;
    
    try {
        // Get the current employee data
        const employee = employees[selectedEmployeeIndex];
        if (!employee) {
            showError('Employee data not found');
            return;
        }
        
        // Prepare the updated data with proper structure
        const updatedData = {
            user: {
                first_name: document.getElementById('detail-name')?.textContent?.trim() || '',
                email: document.getElementById('detail-email')?.textContent?.trim() || ''
            },
            employee_profile: {
                work_location: document.getElementById('detail-location')?.textContent?.trim() || '',
                work_address: document.getElementById('detail-work-address')?.textContent?.trim() || '',
                work_phone: document.getElementById('detail-phone')?.textContent?.trim() || '',
                department: document.getElementById('detail-department')?.textContent?.trim() || '',
                designation: document.getElementById('detail-designation')?.textContent?.trim() || '',
                date_of_joining: formatDateForAPI(document.getElementById('detail-doj')?.textContent?.trim()),
                date_of_birth: formatDateForAPI(document.getElementById('detail-dob')?.textContent?.trim()),
                number_of_children: parseInt(document.getElementById('detail-children-count')?.textContent?.trim()) || 0,
                gender: document.getElementById('detail-gender')?.textContent?.trim() || '', // Send empty string instead of 'N/A'
                personal_address: document.getElementById('detail-address')?.textContent?.trim() || '',
                personal_phone: document.getElementById('detail-personal-phone')?.textContent?.trim() || '',
                personal_email: document.getElementById('detail-personal-email')?.textContent?.trim() || '', // Send empty string instead of 'N/A'
                marital_status: document.getElementById('detail-marital-status')?.textContent?.trim() || '', // Send empty string instead of 'N/A'
                aadhar_number: document.getElementById('detail-aadhar')?.textContent?.trim() || '',
                pan_number: document.getElementById('detail-pan')?.textContent?.trim() || '',
                uan_number: document.getElementById('detail-uan')?.textContent?.trim() || '',
                pf_number: document.getElementById('detail-pf')?.textContent?.trim() || '',
                bank_account_number: document.getElementById('detail-bank-account')?.textContent?.trim() || '',
                bank_name: document.getElementById('detail-bank-name')?.textContent?.trim() || '',
                bank_branch: document.getElementById('detail-bank-branch')?.textContent?.trim() || '',
                bank_ifsc_code: document.getElementById('detail-bank-ifsc')?.textContent?.trim() || '',
                father_name: document.getElementById('detail-father-name')?.textContent?.trim() || '',
                mother_name: document.getElementById('detail-mother-name')?.textContent?.trim() || '',
                spouse_name: document.getElementById('detail-spouse-name')?.textContent?.trim() || '',
                child1_name: document.getElementById('detail-child1-name')?.textContent?.trim() || '',
                child2_name: document.getElementById('detail-child2-name')?.textContent?.trim() || '',
                education_level: document.getElementById('detail-certificate-level')?.textContent?.trim() || '', // Send empty string instead of 'N/A'
                field_of_study: document.getElementById('detail-field-study')?.textContent?.trim() || '',
                school_name: document.getElementById('detail-school-name')?.textContent?.trim() || '',
                employee_id: document.getElementById('detail-empId')?.textContent?.trim() || '',
                employment_type: document.getElementById('detail-empType')?.textContent?.trim() || '',
                blood_group: document.getElementById('detail-blood-group')?.textContent?.trim() || '',
                ctc: document.getElementById('detail-ctc')?.textContent?.trim() ? parseFloat(document.getElementById('detail-ctc').textContent.trim()) : 0
            }
        };
        
        // Show loading state
        saveButton.disabled = true;
        saveButton.textContent = 'Saving...';
        
        // Send update request
        const response = await fetchWithAuth(`/api/company/employees/${employee.id}/`, {
            method: 'PATCH',
            body: JSON.stringify(updatedData)
        });
        
        // Handle response
        let responseData;
        if (response.ok) {
            try {
                const responseText = await response.text();
                responseData = JSON.parse(responseText);
                employees[selectedEmployeeIndex] = responseData;
                
                // Exit edit mode
                isEditMode = false;
                document.querySelectorAll('.info-value').forEach(element => {
                    element.contentEditable = false;
                    element.classList.remove('editing');
                });
                
                document.getElementById('edit-employee-btn').style.display = 'inline-block';
                document.getElementById('save-employee-btn').style.display = 'none';
                document.getElementById('cancel-edit-btn').style.display = 'none';
                
                showSuccess('Employee details updated successfully!');
            } catch (e) {
                console.error('Error parsing response:', e);
                showError('Error parsing server response');
            }
        } else {
            try {
                const responseText = await response.text();
                responseData = JSON.parse(responseText);
                console.error('Error response:', responseData);
                
                // Handle specific field errors
                let errorMessage = 'Failed to update employee details';
                if (responseData.employee_profile) {
                    const fieldErrors = [];
                    for (const [field, errors] of Object.entries(responseData.employee_profile)) {
                        fieldErrors.push(`${field}: ${errors.join(', ')}`);
                    }
                    errorMessage = fieldErrors.join('\n');
                } else if (responseData.error) {
                    errorMessage = responseData.error;
                } else if (responseData.detail) {
                    errorMessage = responseData.detail;
                }
                
                showError(errorMessage);
            } catch (e) {
                console.error('Error parsing error response:', e);
                showError('Failed to update employee details');
            }
        }
    } catch (error) {
        console.error('Error updating employee:', error);
        showError('Error updating employee details');
    } finally {
        // Reset button state
        saveButton.disabled = false;
        saveButton.textContent = originalText;
    }
});

// Helper function to format date for API (e.g., 'YYYY-MM-DD')
function formatDateForAPI(dateString) {
    if (!dateString) return null;
    
    // Handle different date formats
    let dateObj;
    
    // Try to parse as ISO format first
    if (dateString.includes('-') && dateString.length === 10) {
        dateObj = new Date(dateString);
    } else {
        // Try to parse as a regular date string
        const parts = dateString.split('/');
        if (parts.length === 3) {
            dateObj = new Date(`${parts[2]}-${parts[1]}-${parts[0]}`);
        } else {
            dateObj = new Date(dateString);
        }
    }
    
    if (isNaN(dateObj.getTime())) {
        return null; // Invalid date
    }
    
    const year = dateObj.getFullYear();
    const month = String(dateObj.getMonth() + 1).padStart(2, '0');
    const day = String(dateObj.getDate()).padStart(2, '0');
    
    return `${year}-${month}-${day}`;
}

    document.getElementById('cancel-edit-btn').addEventListener('click', function() {
        isEditMode = false;
        document.querySelectorAll('.info-value').forEach(element => {
            element.contentEditable = false;
            element.classList.remove('editing');
        });
        
        document.getElementById('edit-employee-btn').style.display = 'inline-block';
        document.getElementById('save-employee-btn').style.display = 'none';
        document.getElementById('cancel-edit-btn').style.display = 'none';
        
        viewEmployee(selectedEmployeeIndex);
    });
    
    document.getElementById('delete-employee-btn').addEventListener('click', function() {
        deleteEmployee(selectedEmployeeIndex);
    });
    
    document.getElementById('addRequisitionForm').addEventListener('submit', function(e) {
        e.preventDefault();
        addRequisition();
    });

    document.getElementById('statusUpdateForm').addEventListener('submit', function(e) {
        e.preventDefault();
        updateRequisitionStatus();
    });

    document.getElementById('cancelStatusUpdate').addEventListener('click', function() {
        closeModal('statusUpdateModal');
    });
    
    document.getElementById('nextBtn').addEventListener('click', function() {
        if (validateCurrentStep()) {
            if (currentStep < 4) {
                document.getElementById(`step${currentStep}-indicator`).classList.add('completed');
                currentStep++;
                showStep(currentStep);
            }
        }
    });

    document.getElementById('prevBtn').addEventListener('click', function() {
        if (currentStep > 1) {
            document.getElementById(`step${currentStep}-indicator`).classList.remove('completed');
            currentStep--;
            showStep(currentStep);
        }
    });

    document.getElementById('addEmployeeForm').addEventListener('submit', function(e) {
        e.preventDefault();
        if (validateCurrentStep()) {
            addEmployee();
        }
    });

    document.getElementById('cancelBtn').addEventListener('click', function() {
        closeModal('addEmployeeModal');
    });
}

document.getElementById('add-comment-btn').addEventListener('click', function() {
    const commentText = document.getElementById('new-comment').value.trim();
    if (!commentText) return;
    
    const employeeId = employees[selectedEmployeeIndex].id;
    
    fetchWithAuth(`/api/employees/${employeeId}/comments/`, {
        method: 'POST',
        body: JSON.stringify({
            comment: commentText,
            rating: 5  // Default rating
        })
    })
    .then(response => {
        if (response.ok) {
            return response.json();
        } else {
            throw new Error('Failed to add comment');
        }
    })
    .then(data => {
        // Add the new comment to the comments container
        const commentsContainer = document.getElementById('comments-container');
        const commentElement = document.createElement('div');
        commentElement.className = 'comment-item';
        commentElement.innerHTML = `
            <div class="comment-header">
                <span class="comment-author">${currentUser.get_full_name || currentUser.first_name + ' ' + currentUser.last_name}</span>
                <span class="comment-time">Just now</span>
            </div>
            <div class="comment-text">${commentText}</div>
        `;
        commentsContainer.appendChild(commentElement);
        
        // --- THIS IS THE IMPORTANT LINE ---
        // Clear the input field immediately after adding the comment
        document.getElementById('new-comment').value = '';
        
        showSuccess('Comment added successfully!');
    })
    .catch(error => {
        console.error('Error adding comment:', error);
        showError('Failed to add comment');
    });
});



// Load existing comments when viewing an employee
function loadEmployeeComments(employeeId) {
    fetchWithAuth(`/api/employees/${employeeId}/comments/`)
    .then(response => {
        if (response.ok) {
            return response.json();
        } else {
            throw new Error('Failed to load comments');
        }
    })
    .then(comments => {
        const commentsContainer = document.getElementById('comments-container');
        commentsContainer.innerHTML = '';
        
        comments.forEach(comment => {
            const commentElement = document.createElement('div');
            commentElement.className = 'comment-item';
            commentElement.innerHTML = `
                <div class="comment-header">
                    <span class="comment-author">${comment.commented_by_name}</span>
                    <span class="comment-time">${new Date(comment.created_at).toLocaleString()}</span>
                </div>
                <div class="comment-text">${comment.comment}</div>
            `;
            commentsContainer.appendChild(commentElement);
        });
    })
    .catch(error => {
        console.error('Error loading comments:', error);
    });
  }

  async function viewEmployee(index) {
    selectedEmployeeIndex = index;
    const employee = employees[index];
    
    try {
        // Use the correct endpoint
        const response = await fetchWithAuth(`/api/company/employees/${employee.id}/`);
        if (response.ok) {
            const employeeData = await response.json();
            
            // Populate modal with user data
            document.getElementById('detail-name').textContent = employeeData.first_name && employeeData.last_name ? 
                `${employeeData.first_name} ${employeeData.last_name}` : employeeData.email;
            document.getElementById('detail-email').textContent = employeeData.email;
            
            // Get manager name
            let managerName = 'None';
            if (employeeData.manager) {
                if (typeof employeeData.manager === 'object' && employeeData.manager.first_name) {
                    managerName = `${employeeData.manager.first_name} ${employeeData.manager.last_name}`;
                } else if (typeof employeeData.manager === 'string') {
                    managerName = employeeData.manager;
                }
            }
            document.getElementById('detail-manager').textContent = managerName;
            
            // Access nested employee_profile object safely
            const profile = employeeData.employee_profile || {};
            
            // Populate modal with profile data
            document.getElementById('detail-location').textContent = profile.work_location || 'N/A';
            document.getElementById('detail-work-address').textContent = profile.work_address || 'N/A';
            document.getElementById('detail-phone').textContent = profile.work_phone || 'N/A';
            document.getElementById('detail-department').textContent = profile.department || 'N/A';
            document.getElementById('detail-designation').textContent = profile.designation || 'N/A';
            
            // Add all other profile fields with null checks
            document.getElementById('detail-gender').textContent = profile.gender || 'N/A';
            document.getElementById('detail-dob').textContent = profile.date_of_birth || 'N/A';
            document.getElementById('detail-address').textContent = profile.personal_address || 'N/A';
            document.getElementById('detail-personal-phone').textContent = profile.personal_phone || 'N/A';
            document.getElementById('detail-personal-email').textContent = profile.personal_email || 'N/A';
            document.getElementById('detail-aadhar').textContent = profile.aadhar_number || 'N/A';
            document.getElementById('detail-pan').textContent = profile.pan_number || 'N/A';
            document.getElementById('detail-uan').textContent = profile.uan_number || 'N/A';
            document.getElementById('detail-pf').textContent = profile.pf_number || 'N/A';
            document.getElementById('detail-bank-account').textContent = profile.bank_account_number || 'N/A';
            document.getElementById('detail-bank-branch').textContent = profile.bank_branch || 'N/A';
            document.getElementById('detail-bank-ifsc').textContent = profile.bank_ifsc_code || 'N/A';
            document.getElementById('detail-father-name').textContent = profile.father_name || 'N/A';
            document.getElementById('detail-mother-name').textContent = profile.mother_name || 'N/A';
            document.getElementById('detail-marital-status').textContent = profile.marital_status || 'N/A';
            document.getElementById('detail-spouse-name').textContent = profile.spouse_name || 'N/A';
            document.getElementById('detail-children-count').textContent = profile.number_of_children || '0';
            document.getElementById('detail-child1-name').textContent = profile.child1_name || 'N/A';
            document.getElementById('detail-child2-name').textContent = profile.child2_name || 'N/A';
            document.getElementById('detail-certificate-level').textContent = profile.education_level || 'N/A';
            document.getElementById('detail-field-study').textContent = profile.field_of_study || 'N/A';
            document.getElementById('detail-school-name').textContent = profile.school_name || 'N/A';
            document.getElementById('detail-empId').textContent = profile.employee_id || 'N/A';
            document.getElementById('detail-doj').textContent = profile.date_of_joining || 'N/A';
            document.getElementById('detail-empType').textContent = profile.employment_type || 'N/A';
            document.getElementById('detail-blood-group').textContent = profile.blood_group || 'N/A';
            document.getElementById('detail-ctc').textContent = profile.ctc || 'N/A';
            
            // Show/hide edit buttons based on user role
            const isAdmin = currentUser.user_type === 'hr_admin' || currentUser.user_type === 'company_admin';
            document.getElementById('edit-employee-btn').style.display = isAdmin ? 'inline-block' : 'none';
            document.getElementById('delete-employee-btn').style.display = isAdmin ? 'inline-block' : 'none';
            
            // Load comments for this employee
            loadEmployeeComments(employee.id);
            
            showModal('employeeDetailsModal');
        } else {
            showError('Failed to fetch employee details');
        }
    } catch (error) {
        console.error('Error fetching employee details:', error);
        showError('Error fetching employee details');
    }
}



  async function deleteEmployee(index) {
    if (!confirm('Are you sure you want to delete this employee?')) return;
    
    const employee = employees[index];
    
    try {
        // Use the correct endpoint for deleting employees
        const response = await fetchWithAuth(`/api/company/employees/${employee.id}/`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            employees.splice(index, 1);
            renderEmployeesTable();
            renderCards();
            closeModal('employeeDetailsModal');
            showSuccess('Employee deleted successfully!');
        } else {
            const errorText = await response.text();
            console.error('Delete failed:', errorText);
            showError('Failed to delete employee');
        }
    } catch (error) {
        console.error('Error deleting employee:', error);
        showError('Error deleting employee');
    }
}

async function deleteRequisition(index) {
    if (!confirm('Are you sure you want to delete this requisition?')) return;
    
    // Find the actual requisition in the original array
    const requisition = requisitions[index];
    
    try {
        // Use the correct endpoint based on user role
        let deleteUrl;
        if (currentUser.user_type === 'hr_admin') {
            deleteUrl = `/api/hr/requisitions/${requisition.id}/`;
        } else {
            deleteUrl = `/api/requisitions/${requisition.id}/`;
        }

        console.log('Deleting requisition at:', deleteUrl);
        
        const response = await fetchWithAuth(deleteUrl, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            // Remove from the original array
            requisitions.splice(index, 1);
            renderRequisitionsTable();
            renderCards();
            showSuccess('Requisition deleted successfully!');
        } else {
            const errorText = await response.text();
            console.error('Delete failed:', errorText);
            showError('Failed to delete requisition');
        }
    } catch (error) {
        console.error('Error deleting requisition:', error);
        showError('Error deleting requisition');
    }
}

  function showAddEmployeeModal() {
    resetForm();
    currentStep = 1;
    showStep(currentStep);
    showModal('addEmployeeModal');
  }

  function showAddRequisitionModal() {
    document.getElementById('addRequisitionForm').reset();
    showModal('addRequisitionModal');
  }

  function showModal(modalId) {
    document.body.classList.add('modal-open');
    document.body.style.top = `-${window.scrollY}px`;
    document.getElementById(modalId).classList.add('active');
  }

function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.remove('active');
        
        if (modalId === 'viewRequisitionModal') {
            modal.remove();
        }
    }
    
    const scrollY = document.body.style.top;
    document.body.classList.remove('modal-open');
    document.body.style.top = '';
    window.scrollTo(0, parseInt(scrollY || '0') * -1);
}

  function showStep(step) {
    document.querySelectorAll('.step-content').forEach(content => {
      content.classList.remove('active');
    });
    
    document.getElementById(`step${step}`).classList.add('active');
    
    document.querySelectorAll('.step').forEach((indicator, index) => {
      if (index + 1 < step) {
        indicator.classList.add('completed');
        indicator.classList.remove('active');
      } else if (index + 1 === step) {
        indicator.classList.add('active');
        indicator.classList.remove('completed');
      } else {
        indicator.classList.remove('active', 'completed');
      }
    });
    
    document.getElementById('prevBtn').style.display = step === 1 ? 'none' : 'inline-block';
    document.getElementById('nextBtn').style.display = step === 4 ? 'none' : 'inline-block';
    document.getElementById('submitBtn').style.display = step === 4 ? 'inline-block' : 'none';
  }
  


async function addEmployee() {
    try {
        // Get DOM elements with null checks
        const formElements = {
            name: document.getElementById('employeeName'),
            email: document.getElementById('employeeEmail'),
            role: document.getElementById('employeeRole'),
            manager: document.getElementById('employeeManager'),
            workLocation: document.getElementById('workLocation'),
            workAddress: document.getElementById('workAddress'),
            workEmail: document.getElementById('workEmail'),
            workPhone: document.getElementById('workPhone'),
            gender: document.getElementById('gender'),
            dob: document.getElementById('dob'),
            address: document.getElementById('address'),
            personalPhone: document.getElementById('personalPhone'),
            personalEmail: document.getElementById('personalEmail'),
            maritalStatus: document.getElementById('maritalStatus'),
            fatherName: document.getElementById('fatherName'),
            motherName: document.getElementById('motherName'),
            spouseName: document.getElementById('spouseName'),
            childrenCount: document.getElementById('childrenCount'),
            child1Name: document.getElementById('child1Name'),
            child2Name: document.getElementById('child2Name'),
            aadhar: document.getElementById('aadhar'),
            pan: document.getElementById('pan'),
            uan: document.getElementById('uan'),
            pf: document.getElementById('pf'),
            bankAccount: document.getElementById('bankAccount'),
            bankName: document.getElementById('bankName'),
            bankBranch: document.getElementById('bankBranch'),
            bankIfsc: document.getElementById('bankIfsc'),
            empId: document.getElementById('empId'),
            department: document.getElementById('department'),
            designation: document.getElementById('designation'),
            doj: document.getElementById('doj'),
            empType: document.getElementById('empType'),
            bloodGroup: document.getElementById('bloodGroup'),
            ctc: document.getElementById('ctc'),
            submitButton: document.querySelector('#addEmployeeForm button[type="submit"]')
        };

        // Check if critical elements exist
        if (!formElements.name || !formElements.email || !formElements.role || !formElements.department || !formElements.designation) {
            showError('Required form elements are missing. Please refresh the page and try again.');
            console.error('Missing form elements:', {
                name: !!formElements.name,
                email: !!formElements.email,
                role: !!formElements.role,
                department: !!formElements.department,
                designation: !!formElements.designation
            });
            return;
        }

        // Validate required fields
        const requiredFields = [
            { id: 'employeeName', name: 'Name' },
            { id: 'employeeEmail', name: 'Email' },
            { id: 'employeeRole', name: 'Role' },
            { id: 'department', name: 'Department' },
            { id: 'designation', name: 'Designation' }
        ];
        
        for (const field of requiredFields) {
            const element = document.getElementById(field.id);
            if (!element || !element.value.trim()) {
                showError(`${field.name} is required`);
                if (element) element.focus();
                return;
            }
        }

        // Split name into first and last name
        const nameParts = formElements.name.value.trim().split(' ');
        
        // Prepare form data in the correct structure
        const formData = {
            // User data
            email: formElements.email.value.trim(),
            first_name: nameParts[0] || '',
            last_name: nameParts.slice(1).join(' ') || '',
            user_type: formElements.role.value.toLowerCase(),
            password: 'temp123', // Default password
            phone: formElements.workPhone.value.trim(),
            
            // Manager
            manager: formElements.manager.value || null,
            
            // Profile data - use employee_profile prefix as expected by backend
            employee_profile: {
                work_location: formElements.workLocation ? formElements.workLocation.value.trim() : '',
                work_address: formElements.workAddress ? formElements.workAddress.value.trim() : '',
                work_email: formElements.workEmail ? formElements.workEmail.value.trim() : '',
                work_phone: formElements.workPhone ? formElements.workPhone.value.trim() : '',
                gender: formElements.gender ? formElements.gender.value : '',
                date_of_birth: formElements.dob ? formElements.dob.value : '',
                address: formElements.address ? formElements.address.value.trim() : '',
                personal_phone: formElements.personalPhone ? formElements.personalPhone.value.trim() : '',
                personal_email: formElements.personalEmail ? formElements.personalEmail.value.trim() : '',
                marital_status: formElements.maritalStatus ? formElements.maritalStatus.value : '',
                father_name: formElements.fatherName ? formElements.fatherName.value.trim() : '',
                mother_name: formElements.motherName ? formElements.motherName.value.trim() : '',
                spouse_name: formElements.spouseName ? formElements.spouseName.value.trim() : '',
                number_of_children: formElements.childrenCount ? parseInt(formElements.childrenCount.value) || 0 : 0,
                child1_name: formElements.child1Name ? formElements.child1Name.value.trim() : '',
                child2_name: formElements.child2Name ? formElements.child2Name.value.trim() : '',
                aadhar_number: formElements.aadhar ? formElements.aadhar.value.trim() : '',
                pan_number: formElements.pan ? formElements.pan.value.trim() : '',
                uan_number: formElements.uan ? formElements.uan.value.trim() : '',
                pf_number: formElements.pf ? formElements.pf.value.trim() : '',
                bank_account_number: formElements.bankAccount ? formElements.bankAccount.value.trim() : '',
                bank_name: formElements.bankName ? formElements.bankName.value.trim() : '',
                bank_branch: formElements.bankBranch ? formElements.bankBranch.value.trim() : '',
                bank_ifsc_code: formElements.bankIfsc ? formElements.bankIfsc.value.trim() : '',
                employee_id: formElements.empId ? formElements.empId.value.trim() : '',
                department: formElements.department ? formElements.department.value.trim() : '',
                designation: formElements.designation ? formElements.designation.value.trim() : '',
                date_of_joining: formElements.doj ? formElements.doj.value : '',
                employment_type: formElements.empType ? formElements.empType.value : '',
                blood_group: formElements.bloodGroup ? formElements.bloodGroup.value : '',
                ctc: formElements.ctc ? parseFloat(formElements.ctc.value) || 0 : 0
            }
        };
        
        console.log('Sending employee data:', formData);
        
        // Update UI state
        const originalButtonText = formElements.submitButton.textContent;
        formElements.submitButton.disabled = true;
        formElements.submitButton.textContent = 'Adding Employee...';
        
        try {
            const response = await fetchWithAuth('/api/company/employees/', {
                method: 'POST',
                body: JSON.stringify(formData)
            });
            
            if (response.ok) {
                const newEmployee = await response.json();
                employees.push(newEmployee);
                renderEmployeesTable();
                renderCards();
                closeModal('addEmployeeModal');
                resetForm();
                showSuccess('Employee added successfully!');
            } else {
                const errorData = await response.json();
                console.error('Error response:', errorData);
                const errorMessage = errorData.error || errorData.detail || 'Failed to add employee';
                showError(errorMessage);
            }
        } catch (error) {
            console.error('Error adding employee:', error);
            showError('Error adding employee');
        } finally {
            // Reset UI state
            formElements.submitButton.disabled = false;
            formElements.submitButton.textContent = originalButtonText;
        }
    } catch (error) {
        console.error('Unexpected error in addEmployee:', error);
        showError('An unexpected error occurred. Please try again.');
    }
}

// Add this function to your <script> section
async function debugApiResponse(response, functionName) {
    console.log(`===== DEBUG: ${functionName} =====`);
    console.log('Response Status:', response.status);
    console.log('Response Headers:', [...response.headers.entries()]);
    
    let errorText;
    try {
        errorText = await response.text();
        console.log('Error Response Body:', errorText);
        
        // Try to parse as JSON
        try {
            const errorJson = JSON.parse(errorText);
            console.log('Parsed Error JSON:', errorJson);
        } catch (e) {
            console.log('Could not parse error as JSON');
        }
    } catch (e) {
        console.log('Could not get error response body');
    }
    
    return response;
}

// Helper function to show notifications (optional, but good practice)
function showNotification(message, type = 'info') {
    // You can replace alert() with a custom notification system
    alert(`${type.charAt(0).toUpperCase() + type.slice(1)}: ${message}`);
}

async function addRequisition() {
    // --- 1. Get DOM Elements (more efficient) ---
    const formElements = {
        title: document.getElementById('requisitionTitle'),
        description: document.getElementById('requisitionDescription'),
        department: document.getElementById('requisitionDepartment'),
        location: document.getElementById('requisitionLocation'),
        jobType: document.getElementById('requisitionJobType'),
        vacancies: document.getElementById('requisitionVacancies'),
        minExp: document.getElementById('requisitionMinExp'),
        maxExp: document.getElementById('requisitionMaxExp'),
        minSalary: document.getElementById('requisitionMinSalary'),
        maxSalary: document.getElementById('requisitionMaxSalary'),
        requirements: document.getElementById('requisitionRequirements'),
        skills: document.getElementById('requisitionSkills'),
        status: document.getElementById('requisitionStatus'),
        submitButton: document.querySelector('#addRequisitionForm button[type="submit"]')
    };

    // --- 2. Get and Clean Form Data ---
    const getTrimmedValue = (id) => document.getElementById(id).value.trim();
    
    const requisitionData = {
        job_title: getTrimmedValue('requisitionTitle'),
        description: getTrimmedValue('requisitionDescription'),
        department: getTrimmedValue('requisitionDepartment'),
        location: getTrimmedValue('requisitionLocation'),
        job_type: formElements.jobType.value,
        vacancies: parseInt(formElements.vacancies.value) || 1,
        min_experience: parseInt(formElements.minExp.value) || 0,
        max_experience: parseInt(formElements.maxExp.value) || 0,
        min_salary: parseFloat(formElements.minSalary.value) || 0,
        max_salary: parseFloat(formElements.maxSalary.value) || 0,
        requirements: getTrimmedValue('requisitionRequirements'),
        skills_required: getTrimmedValue('requisitionSkills'),
        status: formElements.status.value,
        // Ensure company ID is sent correctly
        company: currentUser.company?.id || currentUser.company,
        submitted_by: currentUser.id
    };

    // --- 3. Client-Side Validation ---
    const requiredFields = ['job_title', 'description', 'department', 'requirements'];
    const missingFields = requiredFields.filter(field => !requisitionData[field]);
    
    if (missingFields.length > 0) {
        const fieldNames = missingFields.map(field => field.replace('_', ' ')).join(', ');
        showNotification(`Please fill in the following required fields: ${fieldNames}`, 'error');
        return; // Stop the function
    }
    
    // --- 4. Update UI State (disable button) ---
    const originalButtonText = formElements.submitButton.textContent;
    formElements.submitButton.disabled = true;
    formElements.submitButton.textContent = 'Posting...';

    console.log('Sending requisition data:', requisitionData);

    try {
        // --- 5. Send API Request ---
        const response = await fetchWithAuth('/api/requisitions/', {
            method: 'POST',
            body: JSON.stringify(requisitionData)
        });

        // --- 6. Handle API Response ---
        if (response.ok) {
            const newRequisition = await response.json();
            requisitions.push(newRequisition); // Add to local array
            renderRequisitionsTable(); // Re-render the table
            renderCards(); // Update dashboard cards
            closeModal('addRequisitionModal'); // Close the modal
            showNotification('Requisition posted successfully!', 'success');
        } else {
            const errorData = await response.json();
            // Construct a more helpful error message
            let errorMessage = 'Failed to post requisition.';
            if (errorData) {
                // If backend sends specific field errors, show them
                const fieldErrors = Object.keys(errorData)
                    .map(key => `${key}: ${errorData[key].join(', ')}`)
                    .join('\n');
                errorMessage = `Validation Error:\n${fieldErrors}`;
            }
            showNotification(errorMessage, 'error');
        }
    } catch (error) {
        console.error('Network or unexpected error:', error);
        showNotification('An unexpected error occurred. Please try again.', 'error');
    } finally {
        // --- 7. Reset UI State (re-enable button) ---
        formElements.submitButton.disabled = false;
        formElements.submitButton.textContent = originalButtonText;
    }
}



function showEmployeeProfileOnly() {
    // Hide all dashboard elements except the profile
    const elementsToHide = [
        '.main-nav',         // Hide the main navigation
        '.quick-actions',    // Hide quick actions
        '.cards-grid',       // Hide the cards grid
        '#employees-panel',  // Hide employees panel
        '#requisitions-panel' // Hide requisitions panel
    ];
    
    elementsToHide.forEach(selector => {
        const element = document.querySelector(selector);
        if (element) element.style.display = 'none';
    });
    
    // Get the container and replace its content with detailed employee profile
    const container = document.querySelector('.container');
    if (container) {
        // Helper function to get value with fallback
        const getValue = (key, fallback = 'N/A') => {
            const value = currentUser[key];
            return value !== null && value !== undefined && value !== '' ? value : fallback;
        };
        
        container.innerHTML = `
            <div style="text-align:center; margin-bottom:30px; padding:20px; background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow);">
                <h1 style="color:var(--darkgreen);">Welcome, ${getValue('first_name', currentUser.email)} ${getValue('last_name', '')}</h1>
                <p style="color:var(--muted);">Employee</p>
            </div>
            
            <!-- Work Information -->
            <div class="section-card" style="background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:20px; margin-bottom:20px;">
                <h3 class="section-header" style="background: linear-gradient(to right, var(--darkgreen), var(--lightgreen)); color: white; padding: 8px 15px; border-radius: 8px; margin-bottom: 15px; font-size: 18px; font-weight: 600;">Work Information</h3>
                <div class="info-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                    <div class="info-item">
                        <div class="info-label" style="font-weight: 600; color: var(--darkgreen); margin-bottom: 5px; font-size: 14px;">Name</div>
                        <div class="info-value" id="emp-name" style="padding: 8px 12px; background: #fff; border-radius: 6px; border: 1px solid #e0e0e0;">${getValue('first_name')} ${getValue('last_name')}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label" style="font-weight: 600; color: var(--darkgreen); margin-bottom: 5px; font-size: 14px;">Work Location</div>
                        <div class="info-value" id="emp-work-location" style="padding: 8px 12px; background: #fff; border-radius: 6px; border: 1px solid #e0e0e0;">${getValue('work_location')}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label" style="font-weight: 600; color: var(--darkgreen); margin-bottom: 5px; font-size: 14px;">Work Address</div>
                        <div class="info-value" id="emp-work-address" style="padding: 8px 12px; background: #fff; border-radius: 6px; border: 1px solid #e0e0e0;">${getValue('work_address')}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label" style="font-weight: 600; color: var(--darkgreen); margin-bottom: 5px; font-size: 14px;">Manager</div>
                        <div class="info-value" id="emp-manager" style="padding: 8px 12px; background: #fff; border-radius: 6px; border: 1px solid #e0e0e0;">${getValue('manager_name', 'None')}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label" style="font-weight: 600; color: var(--darkgreen); margin-bottom: 5px; font-size: 14px;">Work Email</div>
                        <div class="info-value" id="emp-email" style="padding: 8px 12px; background: #fff; border-radius: 6px; border: 1px solid #e0e0e0;">${getValue('email')}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label" style="font-weight: 600; color: var(--darkgreen); margin-bottom: 5px; font-size: 14px;">Work Phone</div>
                        <div class="info-value" id="emp-work-phone" style="padding: 8px 12px; background: #fff; border-radius: 6px; border: 1px solid #e0e0e0;">${getValue('work_phone')}</div>
                    </div>
                </div>
            </div>

            <!-- Personal Information -->
            <div class="section-card" style="background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:20px; margin-bottom:20px;">
                <h3 class="section-header" style="background: linear-gradient(to right, var(--darkgreen), var(--lightgreen)); color: white; padding: 8px 15px; border-radius: 8px; margin-bottom: 15px; font-size: 18px; font-weight: 600;">Personal Information</h3>
                <div class="info-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                    <div class="info-item">
                        <div class="info-label" style="font-weight: 600; color: var(--darkgreen); margin-bottom: 5px; font-size: 14px;">Gender</div>
                        <div class="info-value" id="emp-gender" style="padding: 8px 12px; background: #fff; border-radius: 6px; border: 1px solid #e0e0e0;">${getValue('gender')}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label" style="font-weight: 600; color: var(--darkgreen); margin-bottom: 5px; font-size: 14px;">Date of Birth</div>
                        <div class="info-value" id="emp-dob" style="padding: 8px 12px; background: #fff; border-radius: 6px; border: 1px solid #e0e0e0;">${getValue('date_of_birth')}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label" style="font-weight: 600; color: var(--darkgreen); margin-bottom: 5px; font-size: 14px;">Address</div>
                        <div class="info-value" id="emp-address" style="padding: 8px 12px; background: #fff; border-radius: 6px; border: 1px solid #e0e0e0;">${getValue('personal_address')}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label" style="font-weight: 600; color: var(--darkgreen); margin-bottom: 5px; font-size: 14px;">Phone Number</div>
                        <div class="info-value" id="emp-personal-phone" style="padding: 8px 12px; background: #fff; border-radius: 6px; border: 1px solid #e0e0e0;">${getValue('personal_phone')}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label" style="font-weight: 600; color: var(--darkgreen); margin-bottom: 5px; font-size: 14px;">Email Address</div>
                        <div class="info-value" id="emp-personal-email" style="padding: 8px 12px; background: #fff; border-radius: 6px; border: 1px solid #e0e0e0;">${getValue('personal_email')}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label" style="font-weight: 600; color: var(--darkgreen); margin-bottom: 5px; font-size: 14px;">Aadhar Card Number</div>
                        <div class="info-value" id="emp-aadhar" style="padding: 8px 12px; background: #fff; border-radius: 6px; border: 1px solid #e0e0e0;">${getValue('aadhar_number')}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label" style="font-weight: 600; color: var(--darkgreen); margin-bottom: 5px; font-size: 14px;">Pan Number</div>
                        <div class="info-value" id="emp-pan" style="padding: 8px 12px; background: #fff; border-radius: 6px; border: 1px solid #e0e0e0;">${getValue('pan_number')}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label" style="font-weight: 600; color: var(--darkgreen); margin-bottom: 5px; font-size: 14px;">UAN Number</div>
                        <div class="info-value" id="emp-uan" style="padding: 8px 12px; background: #fff; border-radius: 6px; border: 1px solid #e0e0e0;">${getValue('uan_number')}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label" style="font-weight: 600; color: var(--darkgreen); margin-bottom: 5px; font-size: 14px;">PF Number</div>
                        <div class="info-value" id="emp-pf" style="padding: 8px 12px; background: #fff; border-radius: 6px; border: 1px solid #e0e0e0;">${getValue('pf_number')}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label" style="font-weight: 600; color: var(--darkgreen); margin-bottom: 5px; font-size: 14px;">Bank Account Number</div>
                        <div class="info-value" id="emp-bank-account" style="padding: 8px 12px; background: #fff; border-radius: 6px; border: 1px solid #e0e0e0;">${getValue('bank_account_number')}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label" style="font-weight: 600; color: var(--darkgreen); margin-bottom: 5px; font-size: 14px;">Bank Branch</div>
                        <div class="info-value" id="emp-bank-branch" style="padding: 8px 12px; background: #fff; border-radius: 6px; border: 1px solid #e0e0e0;">${getValue('bank_branch')}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label" style="font-weight: 600; color: var(--darkgreen); margin-bottom: 5px; font-size: 14px;">Bank IFSC Code</div>
                        <div class="info-value" id="emp-bank-ifsc" style="padding: 8px 12px; background: #fff; border-radius: 6px; border: 1px solid #e0e0e0;">${getValue('bank_ifsc_code')}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label" style="font-weight: 600; color: var(--darkgreen); margin-bottom: 5px; font-size: 14px;">Father's Name</div>
                        <div class="info-value" id="emp-father-name" style="padding: 8px 12px; background: #fff; border-radius: 6px; border: 1px solid #e0e0e0;">${getValue('father_name')}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label" style="font-weight: 600; color: var(--darkgreen); margin-bottom: 5px; font-size: 14px;">Mother's Name</div>
                        <div class="info-value" id="emp-mother-name" style="padding: 8px 12px; background: #fff; border-radius: 6px; border: 1px solid #e0e0e0;">${getValue('mother_name')}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label" style="font-weight: 600; color: var(--darkgreen); margin-bottom: 5px; font-size: 14px;">Marital Status</div>
                        <div class="info-value" id="emp-marital-status" style="padding: 8px 12px; background: #fff; border-radius: 6px; border: 1px solid #e0e0e0;">${getValue('marital_status')}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label" style="font-weight: 600; color: var(--darkgreen); margin-bottom: 5px; font-size: 14px;">Spouse's Name</div>
                        <div class="info-value" id="emp-spouse-name" style="padding: 8px 12px; background: #fff; border-radius: 6px; border: 1px solid #e0e0e0;">${getValue('spouse_name')}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label" style="font-weight: 600; color: var(--darkgreen); margin-bottom: 5px; font-size: 14px;">Number of Children</div>
                        <div class="info-value" id="emp-children-count" style="padding: 8px 12px; background: #fff; border-radius: 6px; border: 1px solid #e0e0e0;">${getValue('number_of_children', '0')}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label" style="font-weight: 600; color: var(--darkgreen); margin-bottom: 5px; font-size: 14px;">Child 1's Name</div>
                        <div class="info-value" id="emp-child1-name" style="padding: 8px 12px; background: #fff; border-radius: 6px; border: 1px solid #e0e0e0;">${getValue('child1_name')}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label" style="font-weight: 600; color: var(--darkgreen); margin-bottom: 5px; font-size: 14px;">Child 2's Name</div>
                        <div class="info-value" id="emp-child2-name" style="padding: 8px 12px; background: #fff; border-radius: 6px; border: 1px solid #e0e0e0;">${getValue('child2_name')}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label" style="font-weight: 600; color: var(--darkgreen); margin-bottom: 5px; font-size: 14px;">Certificate Level</div>
                        <div class="info-value" id="emp-certificate-level" style="padding: 8px 12px; background: #fff; border-radius: 6px; border: 1px solid #e0e0e0;">${getValue('education_level')}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label" style="font-weight: 600; color: var(--darkgreen); margin-bottom: 5px; font-size: 14px;">Field of Study</div>
                        <div class="info-value" id="emp-field-study" style="padding: 8px 12px; background: #fff; border-radius: 6px; border: 1px solid #e0e0e0;">${getValue('field_of_study')}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label" style="font-weight: 600; color: var(--darkgreen); margin-bottom: 5px; font-size: 14px;">School Name</div>
                        <div class="info-value" id="emp-school-name" style="padding: 8px 12px; background: #fff; border-radius: 6px; border: 1px solid #e0e0e0;">${getValue('school_name')}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label" style="font-weight: 600; color: var(--darkgreen); margin-bottom: 5px; font-size: 14px;">Educational Qualification</div>
                        <div class="info-value" id="emp-education" style="padding: 8px 12px; background: #fff; border-radius: 6px; border: 1px solid #e0e0e0;">${getValue('education')}</div>
                    </div>
                </div>
            </div>

            <!-- HR Information -->
            <div class="section-card" style="background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:20px; margin-bottom:20px;">
                <h3 class="section-header" style="background: linear-gradient(to right, var(--darkgreen), var(--lightgreen)); color: white; padding: 8px 15px; border-radius: 8px; margin-bottom: 15px; font-size: 18px; font-weight: 600;">HR Information</h3>
                <div class="info-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                    <div class="info-item">
                        <div class="info-label" style="font-weight: 600; color: var(--darkgreen); margin-bottom: 5px; font-size: 14px;">Employee ID</div>
                        <div class="info-value" id="emp-empId" style="padding: 8px 12px; background: #fff; border-radius: 6px; border: 1px solid #e0e0e0;">${getValue('employee_id')}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label" style="font-weight: 600; color: var(--darkgreen); margin-bottom: 5px; font-size: 14px;">Department</div>
                        <div class="info-value" id="emp-department" style="padding: 8px 12px; background: #fff; border-radius: 6px; border: 1px solid #e0e0e0;">${getValue('department')}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label" style="font-weight: 600; color: var(--darkgreen); margin-bottom: 5px; font-size: 14px;">Designation</div>
                        <div class="info-value" id="emp-designation" style="padding: 8px 12px; background: #fff; border-radius: 6px; border: 1px solid #e0e0e0;">${getValue('designation')}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label" style="font-weight: 600; color: var(--darkgreen); margin-bottom: 5px; font-size: 14px;">Date of Joining</div>
                        <div class="info-value" id="emp-doj" style="padding: 8px 12px; background: #fff; border-radius: 6px; border: 1px solid #e0e0e0;">${getValue('date_of_joining')}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label" style="font-weight: 600; color: var(--darkgreen); margin-bottom: 5px; font-size: 14px;">Employment Type</div>
                        <div class="info-value" id="emp-empType" style="padding: 8px 12px; background: #fff; border-radius: 6px; border: 1px solid #e0e0e0;">${getValue('employment_type')}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label" style="font-weight: 600; color: var(--darkgreen); margin-bottom: 5px; font-size: 14px;">Blood Group</div>
                        <div class="info-value" id="emp-blood-group" style="padding: 8px 12px; background: #fff; border-radius: 6px; border: 1px solid #e0e0e0;">${getValue('blood_group')}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label" style="font-weight: 600; color: var(--darkgreen); margin-bottom: 5px; font-size: 14px;">CTC</div>
                        <div class="info-value" id="emp-ctc" style="padding: 8px 12px; background: #fff; border-radius: 6px; border: 1px solid #e0e0e0;">${getValue('ctc')}</div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                <button class="btn primary" id="emp-edit-btn" onclick="enableEmployeeEdit()">Edit Profile</button>
                <button class="btn success" id="emp-save-btn" style="display:none;" onclick="saveEmployeeProfile()">Save Changes</button>
                <button class="btn ghost" id="emp-cancel-btn" style="display:none;" onclick="cancelEmployeeEdit()">Cancel</button>
            </div>
        `;
    }
}

// Function to enable editing mode for employee profile
function enableEmployeeEdit() {
    // Make all info-value elements editable
    document.querySelectorAll('.info-value').forEach(element => {
        element.contentEditable = true;
        element.classList.add('editing');
        element.style.backgroundColor = '#f9f9f9';
        element.style.border = '1px solid var(--darkgreen)';
    });
    
    // Show save and cancel buttons, hide edit button
    document.getElementById('emp-edit-btn').style.display = 'none';
    document.getElementById('emp-save-btn').style.display = 'inline-block';
    document.getElementById('emp-cancel-btn').style.display = 'inline-block';
}

// Function to cancel editing mode for employee profile
function cancelEmployeeEdit() {
    // Reload the page to reset values
    initializeApp();
}

// Function to save employee profile
async function saveEmployeeProfile() {
    
    const saveButton = document.getElementById('emp-save-btn');
    const originalText = saveButton.textContent;
    
    try {
        // Show loading state
        saveButton.disabled = true;
        saveButton.textContent = 'Saving...';
        
        // Prepare the updated data with proper structure
        const updatedData = {
            user: {
                first_name: document.getElementById('emp-name')?.textContent?.trim().split(' ')[0] || '',
                last_name: document.getElementById('emp-name')?.textContent?.trim().split(' ').slice(1).join(' ') || '',
                email: document.getElementById('emp-email')?.textContent?.trim() || ''
            },
            employee_profile: {
                work_location: document.getElementById('emp-work-location')?.textContent?.trim() || '',
                work_address: document.getElementById('emp-work-address')?.textContent?.trim() || '',
                work_phone: document.getElementById('emp-work-phone')?.textContent?.trim() || '',
                department: document.getElementById('emp-department')?.textContent?.trim() || '',
                designation: document.getElementById('emp-designation')?.textContent?.trim() || '',
                date_of_joining: formatDateForAPI(document.getElementById('emp-doj')?.textContent?.trim()),
                date_of_birth: formatDateForAPI(document.getElementById('emp-dob')?.textContent?.trim()),
                number_of_children: parseInt(document.getElementById('emp-children-count')?.textContent?.trim()) || 0,
                gender: document.getElementById('emp-gender')?.textContent?.trim() || '',
                personal_address: document.getElementById('emp-address')?.textContent?.trim() || '',
                personal_phone: document.getElementById('emp-personal-phone')?.textContent?.trim() || '',
                personal_email: document.getElementById('emp-personal-email')?.textContent?.trim() || '',
                aadhar_number: document.getElementById('emp-aadhar')?.textContent?.trim() || '',
                pan_number: document.getElementById('emp-pan')?.textContent?.trim() || '',
                uan_number: document.getElementById('emp-uan')?.textContent?.trim() || '',
                pf_number: document.getElementById('emp-pf')?.textContent?.trim() || '',
                bank_account_number: document.getElementById('emp-bank-account')?.textContent?.trim() || '',
                bank_branch: document.getElementById('emp-bank-branch')?.textContent?.trim() || '',
                bank_ifsc_code: document.getElementById('emp-bank-ifsc')?.textContent?.trim() || '',
                father_name: document.getElementById('emp-father-name')?.textContent?.trim() || '',
                mother_name: document.getElementById('emp-mother-name')?.textContent?.trim() || '',
                marital_status: document.getElementById('emp-marital-status')?.textContent?.trim() || '',
                spouse_name: document.getElementById('emp-spouse-name')?.textContent?.trim() || '',
                child1_name: document.getElementById('emp-child1-name')?.textContent?.trim() || '',
                child2_name: document.getElementById('emp-child2-name')?.textContent?.trim() || '',
                education_level: document.getElementById('emp-certificate-level')?.textContent?.trim() || '',
                field_of_study: document.getElementById('emp-field-study')?.textContent?.trim() || '',
                school_name: document.getElementById('emp-school-name')?.textContent?.trim() || '',
                employee_id: document.getElementById('emp-empId')?.textContent?.trim() || '',
                employment_type: document.getElementById('emp-empType')?.textContent?.trim() || '',
                blood_group: document.getElementById('emp-blood-group')?.textContent?.trim() || '',
                ctc: document.getElementById('emp-ctc')?.textContent?.trim() ? parseFloat(document.getElementById('emp-ctc').textContent.trim()) : 0
            }
        };
        
        console.log('Sending updated data:', updatedData);
        
        // Send update request
        const response = await fetchWithAuth(`/api/company/employees/${currentUser.id}/`, {
            method: 'PATCH',
            body: JSON.stringify(updatedData)
        });
        
        // Handle response
        if (response.ok) {
            const responseData = await response.json();
            console.log('Response data:', responseData);
            
            // Update currentUser with new data
           
            if (responseData.employee_profile) {
                currentUser = {
                    ...currentUser,
                    ...responseData,
                    ...responseData.employee_profile
                };
            } else {
                currentUser = { ...currentUser, ...responseData };
            }
            
            // Exit edit mode
            document.querySelectorAll('.info-value').forEach(element => {
                element.contentEditable = false;
                element.classList.remove('editing');
                element.style.backgroundColor = '#fff';
                element.style.border = '1px solid #e0e0e0';
            });
            
            // Show edit button, hide save and cancel buttons
            document.getElementById('emp-edit-btn').style.display = 'inline-block';
            document.getElementById('emp-save-btn').style.display = 'none';
            document.getElementById('emp-cancel-btn').style.display = 'none';
            
            showSuccess('Profile updated successfully!');
            
            // Reload the profile to show updated data
            setTimeout(() => {
                initializeApp();
            }, 1500);
        } else {
            const errorText = await response.text();
            console.error('Error response:', errorText);
            showError('Failed to update profile');
        }
    } catch (error) {
        console.error('Error updating profile:', error);
        showError('Error updating profile');
    } finally {
        // Reset button state
        saveButton.disabled = false;
        saveButton.textContent = originalText;
    }
}

// Helper function to format date for API (e.g., 'YYYY-MM-DD')
function formatDateForAPI(dateString) {
    if (!dateString || dateString === 'N/A') return null;
    
    // Handle different date formats
    let dateObj;
    
    // Try to parse as ISO format first
    if (dateString.includes('-') && dateString.length === 10) {
        dateObj = new Date(dateString);
    } else {
        // Try to parse as a regular date string
        const parts = dateString.split('/');
        if (parts.length === 3) {
            dateObj = new Date(`${parts[2]}-${parts[1]}-${parts[0]}`);
        } else {
            dateObj = new Date(dateString);
        }
    }
    
    if (isNaN(dateObj.getTime())) {
        return null; // Invalid date
    }
    
    const year = dateObj.getFullYear();
    const month = String(dateObj.getMonth() + 1).padStart(2, '0');
    const day = String(dateObj.getDate()).padStart(2, '0');
    
    return `${year}-${month}-${day}`;
}



async function initializeApp() {
    setupUI();
    
    // Check if the current user is an employee
    if (currentUser.user_type === 'Employee' || currentUser.user_type === 'employee') {
        // Load the complete employee profile data
        try {
            const response = await fetchWithAuth('/api/company/employees/me/');
            if (response.ok) {
                const employeeData = await response.json();
                console.log('Employee data loaded:', employeeData);
                
                if (employeeData.employee_profile) {
                    // Merge user data with profile data
                    currentUser = {
                        ...currentUser,
                        ...employeeData,
                        ...employeeData.employee_profile
                    };
                } else {
                    // If no nested profile, just use the data as is
                    currentUser = { ...currentUser, ...employeeData };
                }
                
                console.log('Merged current user data:', currentUser);
            }
        } catch (error) {
            console.error('Error loading employee profile:', error);
        }
        
        // Show the complete employee profile
        showEmployeeProfileOnly();
        return; // Exit early to prevent loading other data
    } else {
        // For all other user types, show the full dashboard
        console.log('Current user:', currentUser);
        console.log('Auth token:', authToken);
        await loadDashboardData();
        console.log('Employees loaded:', employees);
        console.log('Requisitions loaded:', requisitions);
        renderQuickActions();
        renderCards();
        renderEmployeesTable();
        renderRequisitionsTable();
        setupEventListeners();
    }
}



  function resetForm() {
    document.getElementById('addEmployeeForm').reset();
    document.querySelectorAll('.step').forEach(indicator => {
      indicator.classList.remove('active', 'completed');
    });
    currentStep = 1;
    showStep(currentStep);
  }

  function validateCurrentStep() {
    // For the final submission, we need to validate all required fields across all steps
    if (currentStep === 4) {
        const requiredFields = [
            'employeeName', 'employeeEmail', 'employeeRole', 
            'department', 'designation'
        ];
        
        for (const fieldId of requiredFields) {
            const field = document.getElementById(fieldId);
            if (!field.value.trim()) {
                showError(`${fieldId.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase())} is required`);
                field.focus();
                return false;
            }
        }
        
        // Validate email format
        const emailField = document.getElementById('employeeEmail');
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(emailField.value.trim())) {
            showError('Please enter a valid email address');
            emailField.focus();
            return false;
        }
        
        return true;
    }
    
    // For other steps, validate the current step
    let isValid = true;
    const currentStepElement = document.getElementById(`step${currentStep}`);
    const requiredFields = currentStepElement.querySelectorAll('[required]');
    
    requiredFields.forEach(field => {
        if (!field.value.trim()) {
            isValid = false;
            field.style.borderColor = 'red';
        } else {
            field.style.borderColor = '';
        }
    });
    
    return isValid;
}


  function logout() {
    sessionStorage.removeItem('currentUser');
    sessionStorage.removeItem('authToken');
    window.location.href = 'login.html';
  }

  function showError(message) {
    alert('Error: ' + message);
  }

  function showSuccess(message) {
    alert('Success: ' + message);
  }

  document.getElementById('closeEmployeeModal').addEventListener('click', function() {
    closeModal('employeeDetailsModal');
  });

  document.getElementById('nextBtn').addEventListener('click', function() {
    if (validateCurrentStep()) {
      if (currentStep < 4) {
        document.getElementById(`step${currentStep}-indicator`).classList.add('completed');
        currentStep++;
        showStep(currentStep);
      }
    }
  });

  document.getElementById('prevBtn').addEventListener('click', function() {
    if (currentStep > 1) {
      document.getElementById(`step${currentStep}-indicator`).classList.remove('completed');
      currentStep--;
      showStep(currentStep);
    }
  });

  document.getElementById('addEmployeeForm').addEventListener('submit', function(e) {
    e.preventDefault();
    if (validateCurrentStep()) {
      addEmployee();
    }
  });

  document.getElementById('cancelAddRequisition').addEventListener('click', function() {
    closeModal('addRequisitionModal');
});

 
  </script>
  </body>
  </html>