<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Company Profile â€” NEO TECH Solutions</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  /* ===== Root Variables ===== */
  :root {
    --bg:#f6f7f8;
    --card:#ffffff;
    --text:#22303b;
    --muted:#6f7b83;
    --darkgreen:#00533f;
    --lightgreen:#8fd694;
    --yellow:#ffcc00;
    --red:#ff6347;
    --radius:12px;
    --shadow:0 6px 20px rgba(0,0,0,0.06);
    --transition: all 0.3s ease;
  }

  *{box-sizing:border-box;}
  body{margin:0;font-family:"Inter",sans-serif;background:var(--bg);color:var(--text);}

  /* ===== Top Navigation ===== */
  .topbar{
    background: var(--darkgreen);
    color:#fff;
    position:sticky; top:0; z-index:10;
    box-shadow:0 4px 14px rgba(0,0,0,0.1);
  }
  .topbar-inner{
    max-width:1400px;
    margin:auto;
    padding:14px 20px;
    display:flex;
    justify-content:space-between;
    align-items:center;
  }
  .brand{display:flex;align-items:center;gap:10px;}
  .brand img{width:40px;border-radius:6px;}
  .brand span{font-size:1.2rem;font-weight:700;}
  .main-nav{display:flex;gap:20px;}
  .nav-link{
    color:#fff;text-decoration:none;font-weight:500;position:relative;
    transition:var(--transition);padding:6px 0;
  }
  .nav-link::after{
    content:"";position:absolute;left:0;bottom:-3px;width:0;height:2px;
    background:var(--yellow);border-radius:2px;transition:var(--transition);
  }
  .nav-link:hover::after, .nav-link.active::after{width:100%;}
  .nav-link:hover{opacity:0.9;}
  .avatar{
    width:38px;height:38px;background:rgba(255,255,255,0.15);
    display:flex; align-items:center; justify-content:center;
    border-radius:8px;font-weight:700;cursor:pointer;
    transition:var(--transition);
  }
  .avatar:hover{background:rgba(255,255,255,0.25);}

  /* ===== Container ===== */
  .container{max-width:1400px;margin:28px auto;padding:0 20px}

  /* ===== Company Profile ===== */
  .company-profile {
    display: flex;
    gap: 30px;
    margin-bottom: 30px;
  }
  .company-image {
    flex: 0 0 300px;
  }
  .company-image img {
    width: 100%;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
  }
  .company-info {
    flex: 1;
  }
  .company-name {
    font-size: 28px;
    font-weight: 700;
    color: var(--darkgreen);
    margin-bottom: 10px;
  }
  .company-tagline {
    font-size: 16px;
    color: var(--muted);
    margin-bottom: 20px;
  }
  .company-details {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 15px;
  }
  .detail-item {
    display: flex;
    align-items: flex-start;
    gap: 10px;
  }
  .detail-icon {
    color: var(--darkgreen);
    font-size: 18px;
    margin-top: 2px;
  }
  .detail-content {
    flex: 1;
  }
  .detail-label {
    font-weight: 600;
    margin-bottom: 5px;
    font-size: 14px;
  }
  .detail-value {
    font-size: 15px;
  }

  /* ===== Company Description ===== */
  .company-description {
    background: var(--card);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    padding: 25px;
    margin-bottom: 30px;
  }
  .section-title {
    font-size: 20px;
    font-weight: 700;
    color: var(--darkgreen);
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .description-text {
    line-height: 1.6;
    font-size: 15px;
  }

  /* ===== Edit Button ===== */
  .edit-btn {
    position: fixed;
    bottom: 30px;
    right: 30px;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: var(--darkgreen);
    color: white;
    border: none;
    font-size: 20px;
    cursor: pointer;
    box-shadow: var(--shadow);
    transition: var(--transition);
    z-index: 10;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .edit-btn:hover {
    background: var(--lightgreen);
    transform: scale(1.1);
  }

  /* ===== Profile Dropdown ===== */
  .profile-dropdown{
    position:absolute;
    top:60px;
    right:20px;
    width:220px;
    background:var(--card);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    display:none;
    flex-direction:column;
    padding:12px;
    z-index:100;
  }
  .profile-header{
    display:flex;
    align-items:center;
    gap:10px;
    margin-bottom:12px;
    padding-bottom:12px;
    border-bottom:1px solid #eee;
  }
  .profile-header img{
    width:50px;
    height:50px;
    border-radius:50%;
    object-fit:cover;
    border:2px solid var(--darkgreen);
  }
  .profile-header strong{
    font-size:14px;
    color:var(--darkgreen);
  }
  .profile-header div{
    font-size:12px;
    color:var(--muted);
  }
  .profile-actions .btn{
    width:100%;
    margin-bottom:6px;
    font-size:13px;
    justify-content:center;
  }

  /* ===== Edit Modal ===== */
  .overlay {
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.5);
    backdrop-filter: blur(2px);
    justify-content: center;
    align-items: center;
    z-index: 100;
  }
  .overlay.active {
    display: flex;
  }
  .overlay-content {
    background: #fff;
    border-radius: var(--radius);
    padding: 30px;
    width: 90%;
    max-width: 800px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    animation: slideDown 0.3s ease-out;
  }
  @keyframes slideDown {
    from {transform: translateY(-30px); opacity:0;}
    to {transform: translateY(0); opacity:1;}
  }
  .overlay h3 {
    margin-top: 0;
    margin-bottom: 20px;
    color: var(--darkgreen);
    text-align: center;
    font-size: 24px;
  }
  .form-group {margin-bottom: 15px;}
  .form-group label {display:block; font-weight:600; margin-bottom:5px; color:var(--text);}
  .form-group input, .form-group textarea, .form-group select {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #ccc;
    border-radius: 8px;
    font-size: 14px;
    transition: var(--transition);
  }
  .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
    border-color: var(--darkgreen);
    outline: none;
    box-shadow: 0 0 0 2px rgba(0, 83, 63, 0.2);
  }
  .form-buttons {display:flex; justify-content:flex-end; gap:10px; margin-top:20px;}
  .btn{
    background:#fff;border:1px solid var(--darkgreen);
    color:var(--darkgreen);padding:10px 16px;border-radius:8px;font-weight:600;
    cursor:pointer; transition:var(--transition);
    display:inline-flex;align-items:center;gap:8px;
  }
  .btn:hover{background:var(--darkgreen); color:#fff;transform: translateY(-2px);}
  .btn.primary{background:var(--darkgreen);color:#fff;border:none;}
  .btn.ghost{background:transparent;border:1px solid #ccc;color:var(--text);}
  .btn.danger{background:var(--red);color:#fff;border:none;}
  .btn.small{padding:6px 10px;font-size:13px;}

  /* ===== Form Sections ===== */
  .form-section {
    margin-bottom: 25px;
    padding-bottom: 20px;
    border-bottom: 1px solid #eee;
  }
  .form-section:last-child {
    border-bottom: none;
  }
  .section-title {
    font-size: 18px;
    font-weight: 600;
    color: var(--darkgreen);
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .form-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 15px;
  }

  /* ===== Image Upload ===== */
  .image-upload {
    margin-bottom: 15px;
    text-align: center;
  }
  .image-preview {
    width: 200px;
    height: 200px;
    border-radius: 8px;
    background: #f9f9f9;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    margin: 0 auto 15px;
    border: 2px dashed #ccc;
  }
  .image-preview img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
  }
  .upload-btn {
    background: #f0f0f0;
    border: 1px dashed #ccc;
    padding: 8px 15px;
    border-radius: 6px;
    cursor: pointer;
    display: inline-block;
    transition: var(--transition);
  }
  .upload-btn:hover {
    background: #e0e0e0;
  }

  /* ===== Responsive ===== */
  @media(max-width:768px){
    .main-nav{display:none}
    .company-profile {
      flex-direction: column;
    }
    .company-image {
      flex: 0 0 auto;
    }
    .form-row {
      grid-template-columns: 1fr;
    }
  }
</style>
</head>
<body>

<!-- Topbar -->
<header class="topbar">
  <div class="topbar-inner">
    <div class="brand">
      <img src="./company_logo.jpg" alt="Logo">
      <span>NEO TECH Solutions</span>
    </div>
    <nav class="main-nav">
      <a href="./dashboard.html" class="nav-link" data-page="dashboard">Dashboard</a>
      <a href="employee.html" class="nav-link" data-page="employees">Employees</a>
      <a href="requsition.html" class="nav-link" data-page="requisitions">Requisitions</a>
      <a href="./company_profile.html" class="nav-link active" data-page="company">Company Profile</a>
      <a href="./profile.html" class="nav-link" data-page="profile">My Profile</a>
    </nav>
    <div class="avatar" id="user-avatar"></div>
  </div>
</header>

<!-- Profile Dropdown -->
<div class="profile-dropdown" id="profile-dropdown">
  <div class="profile-header">
    <img src="https://picsum.photos/seed/profile/50/50.jpg" alt="Profile Image" id="profile-img">
    <div>
      <strong id="profile-name">User</strong>
      <div id="profile-role">Role</div>
    </div>
  </div>
  <div class="profile-actions">
    <button class="btn small primary" id="edit-profile-btn">Edit Profile</button>
    <button class="btn small ghost" id="logout-btn">Logout</button>
  </div>
</div>

<main class="container">

  <!-- Company Profile -->
  <div class="company-profile">
    <div class="company-image">
      <img id="company-logo" src="./company_logo.jpg" alt="Company Logo">
    </div>
    <div class="company-info">
      <h1 class="company-name" id="company-name">NEO TECH Solutions</h1>
      <p class="company-tagline" id="company-tagline">Innovating the Future of Technology</p>
      
      <div class="company-details">
        <div class="detail-item">
          <i class="fas fa-envelope detail-icon"></i>
          <div class="detail-content">
            <div class="detail-label">Email</div>
            <div class="detail-value" id="company-email">info@neotech.com</div>
          </div>
        </div>
        <div class="detail-item">
          <i class="fas fa-phone detail-icon"></i>
          <div class="detail-content">
            <div class="detail-label">Phone</div>
            <div class="detail-value" id="company-phone">+1 (555) 123-4567</div>
          </div>
        </div>
        <div class="detail-item">
          <i class="fas fa-map-marker-alt detail-icon"></i>
          <div class="detail-content">
            <div class="detail-label">Address</div>
            <div class="detail-value" id="company-address">123 Tech Street, Silicon Valley, CA 94025</div>
          </div>
        </div>
        <div class="detail-item">
          <i class="fas fa-globe detail-icon"></i>
          <div class="detail-content">
            <div class="detail-label">Website</div>
            <div class="detail-value" id="company-website">www.neotech.com</div>
          </div>
        </div>
        <div class="detail-item">
          <i class="fas fa-calendar-alt detail-icon"></i>
          <div class="detail-content">
            <div class="detail-label">Founded</div>
            <div class="detail-value" id="company-founded">2015</div>
          </div>
        </div>
        <div class="detail-item">
          <i class="fas fa-users detail-icon"></i>
          <div class="detail-content">
            <div class="detail-label">Employees</div>
            <div class="detail-value" id="company-employees">250+</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Company Description -->
  <div class="company-description">
    <h2 class="section-title">
      <i class="fas fa-info-circle"></i> About Us
    </h2>
    <p class="description-text" id="company-description">
      NEO TECH Solutions is a leading technology company specializing in innovative software solutions for businesses worldwide. Founded in 2015, we have grown from a small startup to a team of over 250 talented professionals dedicated to pushing the boundaries of what's possible in technology.
      
      Our mission is to empower businesses with cutting-edge technology solutions that drive growth, efficiency, and innovation. We specialize in custom software development, cloud solutions, AI and machine learning, and digital transformation services.
      
      At NEO TECH, we believe in fostering a culture of creativity, collaboration, and continuous learning. Our team is comprised of industry experts who are passionate about solving complex challenges and delivering exceptional value to our clients.
    </p>
  </div>

</main>

<!-- Edit Button (only visible to Admin and Management) -->
<button class="edit-btn" id="edit-company-btn">
  <i class="fas fa-edit"></i>
</button>

<!-- Edit Company Modal -->
<div id="editCompanyModal" class="overlay">
  <div class="overlay-content">
    <h3>Edit Company Profile</h3>
    <form id="editCompanyForm">
      <!-- Logo Section -->
      <div class="form-section">
        <div class="section-title">
          <i class="fas fa-image"></i> Company Logo
        </div>
        <div class="image-upload">
          <div class="image-preview">
            <img id="logo-preview" src="./company_logo.jpg" alt="Company Logo">
          </div>
          <label for="logo-upload" class="upload-btn">
            <i class="fas fa-upload"></i> Upload Logo
          </label>
          <input type="file" id="logo-upload" accept="image/*" style="display: none;">
        </div>
      </div>
      
      <!-- Basic Information Section -->
      <div class="form-section">
        <div class="section-title">
          <i class="fas fa-info-circle"></i> Basic Information
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="edit-company-name">Company Name</label>
            <input type="text" id="edit-company-name" required>
          </div>
          <div class="form-group">
            <label for="edit-company-tagline">Tagline</label>
            <input type="text" id="edit-company-tagline">
          </div>
        </div>
      </div>
      
      <!-- Contact Information Section -->
      <div class="form-section">
        <div class="section-title">
          <i class="fas fa-address-book"></i> Contact Information
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="edit-company-email">Email</label>
            <input type="email" id="edit-company-email" required>
          </div>
          <div class="form-group">
            <label for="edit-company-phone">Phone</label>
            <input type="text" id="edit-company-phone" required>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="edit-company-address">Address</label>
            <input type="text" id="edit-company-address" required>
          </div>
          <div class="form-group">
            <label for="edit-company-website">Website</label>
            <input type="text" id="edit-company-website">
          </div>
        </div>
      </div>
      
      <!-- Company Details Section -->
      <div class="form-section">
        <div class="section-title">
          <i class="fas fa-building"></i> Company Details
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="edit-company-founded">Founded</label>
            <input type="text" id="edit-company-founded">
          </div>
          <div class="form-group">
            <label for="edit-company-employees">Number of Employees</label>
            <input type="text" id="edit-company-employees">
          </div>
        </div>
      </div>
      
      <!-- Company Description Section -->
      <div class="form-section">
        <div class="section-title">
          <i class="fas fa-align-left"></i> Company Description
        </div>
        <div class="form-group">
          <label for="edit-company-description">Description</label>
          <textarea id="edit-company-description" rows="6"></textarea>
        </div>
      </div>
      
      <div class="form-buttons">
        <button type="button" class="btn ghost" id="cancel-edit-company">
          <i class="fas fa-times"></i> Cancel
        </button>
        <button type="submit" class="btn primary">
          <i class="fas fa-save"></i> Save Changes
        </button>
      </div>
    </form>
  </div>
</div>

<script>
// ===== Global Variables =====
let currentUser = {};
let companyData = {};
let authToken = '';

// ===== Initialize =====
document.addEventListener('DOMContentLoaded', function() {
  authToken = sessionStorage.getItem('authToken');
  const userStr = sessionStorage.getItem('currentUser');
  
  if (!userStr || !authToken) {
    window.location.href = 'login.html';
    return;
  }
  
  currentUser = JSON.parse(userStr);
  initializeApp();
});

async function initializeApp() {
  setupUI();
  
  if (currentUser.user_type === 'employee') {
    showEmployeeProfile();
  } else {
    await loadCompanyData();
    renderCompanyProfile();
    setupEventListeners();
  }
}



function setupUI() {
  // Set user info in UI
  document.getElementById('profile-name').textContent = currentUser.get_full_name || currentUser.first_name + ' ' + currentUser.last_name || currentUser.email;
  document.getElementById('profile-role').textContent = formatUserRole(currentUser.user_type || currentUser.role);
  document.getElementById('user-avatar').textContent = (currentUser.get_full_name || currentUser.first_name + ' ' + currentUser.last_name || currentUser.email).charAt(0).toUpperCase();
  
  // DEBUG: Log the user type to see what we're getting from the backend
  console.log('DEBUG: Current user_type:', currentUser.user_type);
  console.log('DEBUG: Current role:', currentUser.role);

  
  // Check for multiple possible admin roles to be more robust
  const isAdmin = currentUser.user_type === 'hr_admin' || 
                  currentUser.user_type === 'admin' || 
                  currentUser.user_type === 'company_admin'; 

  const editButton = document.getElementById('edit-company-btn');
  if (editButton) {
    editButton.style.display = isAdmin ? 'flex' : 'none';
    console.log('DEBUG: Edit button display set to:', editButton.style.display);
  }

  // For non-admin users, add a "view-only" indicator to the company profile section
  const companyProfileSection = document.querySelector('.company-profile');
  if (companyProfileSection && !isAdmin) {
    // Create a simple indicator
    const viewOnlyIndicator = document.createElement('div');
    viewOnlyIndicator.id = 'view-only-indicator';
    viewOnlyIndicator.style.cssText = `
      position: absolute;
      top: 10px;
      right: 10px;
      background: var(--yellow);
      color: var(--darkgreen);
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
    `;
    viewOnlyIndicator.innerHTML = '<i class="fas fa-lock"></i> View Only';
    companyProfileSection.style.position = 'relative'; // Needed for absolute positioning
    companyProfileSection.appendChild(viewOnlyIndicator);
  }
}

function formatUserRole(role) {
  const roleMap = {
    'hr_admin': 'HR Admin',
    'company_admin': 'Company Admin', 
    'management': 'Management',
    'supervisor': 'Supervisor',
    'employee': 'Employee',
    'candidate': 'Candidate'
  };
  return roleMap[role] || role || 'Unknown';
}

async function loadCompanyData() {
  try {
    // First, get current user details to ensure we have the latest data
    const userResponse = await fetchWithAuth('/api/users/me/');
    if (userResponse.ok) {
      const userData = await userResponse.json();
      currentUser = userData;
      sessionStorage.setItem('currentUser', JSON.stringify(userData));
    }
    
    // Then load company data
    const response = await fetchWithAuth(`/api/companies/${currentUser.company}/`);
    if (response.ok) {
      companyData = await response.json();
    } else {
      // If company endpoint fails, try to get from user data
      companyData = {
        name: 'NEO TECH Solutions',
        tagline: 'Innovating the Future of Technology',
        email: 'info@neotech.com',
        phone: '+1 (555) 123-4567',
        address: '123 Tech Street, Silicon Valley, CA 94025',
        website: 'www.neotech.com',
        founded: '2015',
        employees: '250+',
        description: `NEO TECH Solutions is a leading technology company specializing in innovative software solutions for businesses worldwide. Founded in 2015, we have grown from a small startup to a team of over 250 talented professionals dedicated to pushing the boundaries of what's possible in technology.
      
      Our mission is to empower businesses with cutting-edge technology solutions that drive growth, efficiency, and innovation. We specialize in custom software development, cloud solutions, AI and machine learning, and digital transformation services.
      
      At NEO TECH, we believe in fostering a culture of creativity, collaboration, and continuous learning. Our team is comprised of industry experts who are passionate about solving complex challenges and delivering exceptional value to our clients.`,
        logo: "./company_logo.jpg"
      };
    }
  } catch (error) {
    console.error('Error loading company data:', error);
    // Use default data if API fails
    companyData = {
      name: 'NEO TECH Solutions',
      tagline: 'Innovating the Future of Technology',
      email: 'info@neotech.com',
      phone: '+1 (555) 123-4567',
      address: '123 Tech Street, Silicon Valley, CA 94025',
      website: 'www.neotech.com',
      founded: '2015',
      employees: '250+',
      description: `NEO TECH Solutions is a leading technology company specializing in innovative software solutions for businesses worldwide. Founded in 2015, we have grown from a small startup to a team of over 250 talented professionals dedicated to pushing the boundaries of what's possible in technology.
      
      Our mission is to empower businesses with cutting-edge technology solutions that drive growth, efficiency, and innovation. We specialize in custom software development, cloud solutions, AI and machine learning, and digital transformation services.
      
      At NEO TECH, we believe in fostering a culture of creativity, collaboration, and continuous learning. Our team is comprised of industry experts who are passionate about solving complex challenges and delivering exceptional value to our clients.`,
      logo: "./company_logo.jpg"
    };
  }
}

function fetchWithAuth(url, options = {}) {
  const defaultOptions = {
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Token ${authToken}`
    }
  };
  
  // Ensure URL has trailing slash
  const fullUrl = url.endsWith('/') ? 
    `http://127.0.0.1:8000${url}` : 
    `http://127.0.0.1:8000${url}/`;
  
  console.log('Making request to:', fullUrl);
  
  return fetch(fullUrl, {
    ...defaultOptions,
    ...options
  }).then(async response => {
    console.log('Response status:', response.status);
    
    if (!response.ok) {
      let errorText;
      try {
        errorText = await response.text();
        console.error('Error response body:', errorText);
      } catch (e) {
        console.error('Could not parse error response');
      }
    }
    
    return response;
  }).catch(error => {
    console.error('Network error:', error);
    throw error;
  });
}

function renderCompanyProfile() {
  // Update company profile in UI
  document.getElementById('company-name').textContent = companyData.name || 'N/A';
  document.getElementById('company-tagline').textContent = companyData.tagline || 'N/A';
  document.getElementById('company-email').textContent = companyData.email || 'N/A';
  document.getElementById('company-phone').textContent = companyData.phone || 'N/A';
  document.getElementById('company-address').textContent = companyData.address || 'N/A';
  document.getElementById('company-website').textContent = companyData.website || 'N/A';
  document.getElementById('company-founded').textContent = companyData.founded || 'N/A';
  document.getElementById('company-employees').textContent = companyData.employees || 'N/A';
  document.getElementById('company-description').textContent = companyData.description || 'N/A';
  document.getElementById('company-logo').src = companyData.logo || "./company_logo.jpg";
}

function showEmployeeProfile() {
  const mainNav = document.querySelector('.main-nav');
  if (mainNav) mainNav.style.display = 'none';
  
  const quickActions = document.querySelector('.quick-actions');
  if (quickActions) quickActions.style.display = 'none';
  
  const companyProfile = document.querySelector('.company-profile');
  if (companyProfile) companyProfile.style.display = 'none';
  
  const companyDescription = document.querySelector('.company-description');
  if (companyDescription) companyDescription.style.display = 'none';
  
  const editBtn = document.getElementById('edit-company-btn');
  if (editBtn) editBtn.style.display = 'none';
  
  const container = document.querySelector('.container');
  if (container) {
    container.innerHTML = `
      <div style="text-align:center; margin-bottom:30px; padding:20px; background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow);">
        <h1 style="color:var(--darkgreen);">Welcome, ${currentUser.get_full_name || currentUser.first_name}</h1>
        <p style="color:var(--muted);">${formatUserRole(currentUser.user_type || currentUser.role)}</p>
      </div>
      
      <div style="background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:20px;">
        <h3 style="color:var(--darkgreen); margin-bottom:15px;">Your Profile</h3>
        <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(250px, 1fr)); gap:15px;">
          <div><strong>Email:</strong> ${currentUser.email}</div>
          <div><strong>Role:</strong> ${formatUserRole(currentUser.user_type || currentUser.role)}</div>
          <div><strong>Department:</strong> ${currentUser.department || 'TBD'}</div>
          <div><strong>Phone:</strong> ${currentUser.phone || 'TBD'}</div>
        </div>
      </div>
    `;
  }
}

function setupEventListeners() {
  // Profile dropdown
  document.getElementById('user-avatar').addEventListener('click', function() {
    document.getElementById('profile-dropdown').style.display = 
      document.getElementById('profile-dropdown').style.display === 'flex' ? 'none' : 'flex';
  });
  
  document.addEventListener('click', function(e) {
    const profileDropdown = document.getElementById('profile-dropdown');
    const avatar = document.getElementById('user-avatar');
    
    if (!profileDropdown.contains(e.target) && e.target !== avatar) {
      profileDropdown.style.display = 'none';
    }
  });
  
  // Edit profile button
  document.getElementById('edit-profile-btn').addEventListener('click', function() {
    window.location.href = 'profile.html';
  });
  
  // Logout button
  document.getElementById('logout-btn').addEventListener('click', logout);
  
  // Edit company button
  const editCompanyBtn = document.getElementById('edit-company-btn');
  if (editCompanyBtn) {
    editCompanyBtn.addEventListener('click', showEditCompanyModal);
  }
  
  // Cancel edit company
  document.getElementById('cancel-edit-company').addEventListener('click', function() {
    document.getElementById('editCompanyModal').classList.remove('active');
  });
  
  // Edit company form
  document.getElementById('editCompanyForm').addEventListener('submit', function(e) {
    e.preventDefault();
    saveCompanyChanges();
  });
  
  // Logo upload
  document.getElementById('logo-upload').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function(event) {
        document.getElementById('logo-preview').src = event.target.result;
      };
      reader.readAsDataURL(file);
    }
  });
}



function showEditCompanyModal() {
  // Populate form with current data
  document.getElementById('edit-company-name').value = companyData.name || '';
  document.getElementById('edit-company-tagline').value = companyData.tagline || '';
  document.getElementById('edit-company-email').value = companyData.email || '';
  document.getElementById('edit-company-phone').value = companyData.phone || '';
  document.getElementById('edit-company-address').value = companyData.address || '';
  document.getElementById('edit-company-website').value = companyData.website || '';
  document.getElementById('edit-company-founded').value = companyData.founded || '';
  document.getElementById('edit-company-employees').value = companyData.employees || '';
  document.getElementById('edit-company-description').value = companyData.description || '';
  document.getElementById('logo-preview').src = companyData.logo || "./company_logo.jpg";
  
  // Show modal
  document.getElementById('editCompanyModal').classList.add('active');
}

async function saveCompanyChanges() {
  // Update company data with form values
  companyData.name = document.getElementById('edit-company-name').value;
  companyData.tagline = document.getElementById('edit-company-tagline').value;
  companyData.email = document.getElementById('edit-company-email').value;
  companyData.phone = document.getElementById('edit-company-phone').value;
  companyData.address = document.getElementById('edit-company-address').value;
  companyData.website = document.getElementById('edit-company-website').value;
  companyData.founded = document.getElementById('edit-company-founded').value;
  companyData.employees = document.getElementById('edit-company-employees').value;
  companyData.description = document.getElementById('edit-company-description').value;
  companyData.logo = document.getElementById('logo-preview').src;
  
  try {
    const response = await fetchWithAuth(`/api/companies/${currentUser.company}/`, {
      method: 'PATCH',
      body: JSON.stringify(companyData)
    });
    
    if (response.ok) {
      // Update UI
      renderCompanyProfile();
      document.getElementById('editCompanyModal').classList.remove('active');
      alert('Company profile updated successfully!');
    } else {
      // Try to get error message
      try {
        const error = await response.json();
        let errorMessage = 'Failed to update company profile';
        
        if (error && typeof error === 'object') {
          // Extract field errors from the response
          const fieldErrors = [];
          for (const field in error) {
            if (error[field] && Array.isArray(error[field])) {
              fieldErrors.push(`${field}: ${error[field].join(', ')}`);
            }
          }
          if (fieldErrors.length > 0) {
            errorMessage = fieldErrors.join('\n');
          }
        }
        
        alert('Error: ' + errorMessage);
      } catch (e) {
        
        alert('Error: Failed to update company profile. Please check your form data.');
      }
    }
  } catch (error) {
    console.error('Error updating company profile:', error);
    alert('Error updating company profile');
  }
}

function logout() {
  sessionStorage.removeItem('currentUser');
  sessionStorage.removeItem('authToken');
  window.location.href = 'login.html';
}
</script>
</body>
</html>